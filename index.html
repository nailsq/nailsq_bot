<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nails Master PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ВАШ ИСХОДНЫЙ CSS КОД */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #000000;
            color: white;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 80px;
        }

        .app {
            max-width: 400px;
            margin: 0 auto;
        }

        /* Анимации */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Навигация с анимацией */
        .top-nav {
            display: flex;
            background: #1a1a1a;
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
            align-items: center;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            line-height: 1.2;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item.active {
            background: #0078D4;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .nav-item:not(.active) {
            color: #888888;
        }

        .nav-item:not(.active):hover {
            color: #ffffff;
            transform: translateY(-1px);
        }

        /* Контент вкладок с анимацией */
        .tab-content {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeInUp 0.5s ease-out;
        }

        /* Прямоугольные аватары с анимацией */
        .avatar-rect {
            width: 80px;
            height: 100px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            animation: scaleIn 0.6s ease-out;
        }

        .master-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .user-avatar {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
        }

        .reviewer-avatar {
            width: 50px;
            height: 60px;
            border-radius: 8px;
        }

        .avatar-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* Профиль мастера с анимацией */
        .master-profile {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            animation: slideInRight 0.6s ease-out;
        }

        .master-info h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .master-info p {
            color: #888888;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stars {
            color: #ffd700;
            font-size: 14px;
        }

        .rating-text {
            color: #888888;
            font-size: 14px;
        }

        /* Секции с анимацией */
        .section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
            animation-delay: 0.1s;
            animation-fill-mode: both;
        }

        .section:nth-child(2) {
            animation-delay: 0.2s;
        }

        .section:nth-child(3) {
            animation-delay: 0.3s;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .see-all {
            color: #0078D4;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .see-all:hover {
            background: rgba(0, 120, 212, 0.1);
            transform: translateX(2px);
        }

        /* Хиты продаж с улучшенной анимацией */
        .hits-scroll {
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .hits-container {
            display: flex;
            gap: 12px;
            width: max-content;
        }

        .hit-card {
            background: #252525;
            border-radius: 12px;
            padding: 0;
            border: 1px solid #333333;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 200px;
            flex-shrink: 0;
            animation: fadeInUp 0.6s ease-out;
            position: relative;
        }

        .hit-card:hover {
            border-color: #0078D4;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 120, 212, 0.2);
        }

        .hit-image {
            width: 100%;
            height: 120px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .hit-card:hover .hit-image {
            transform: scale(1.05);
        }

        .hit-info {
            padding: 12px;
        }

        .hit-info h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .hit-description {
            color: #888888;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .hit-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hit-price {
            font-size: 16px;
            font-weight: 600;
            color: #0078D4;
        }

        /* Кнопка записи */
        .book-btn {
            background: #0078D4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .book-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .book-btn:hover::before {
            left: 100%;
        }

        .book-btn:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .book-btn.added {
            background: #00a86b;
            animation: bounceIn 0.6s ease-out;
        }

        /* Кнопка избранного */
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            animation: heartBeat 0.6s ease-out;
        }

        .favorite-btn.active .heart-icon {
            color: #ff4757;
        }

        .heart-icon {
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        /* Примеры работ */
        .works-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .work-card {
            aspect-ratio: 1;
            background: linear-gradient(45deg, #ff6b6b, #ffa8a8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .work-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        /* Услуги с анимацией */
        .services-header {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
        }

        .services-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .service-categories {
            display: flex;
            background: #1a1a1a;
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            gap: 4px;
            overflow-x: auto;
            animation: fadeInUp 0.6s ease-out;
        }

        .service-category {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .service-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .service-category:hover::before {
            left: 100%;
        }

        .service-category.active {
            background: #0078D4;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .service-category:not(.active) {
            color: #888888;
        }

        .service-category:not(.active):hover {
            color: #ffffff;
            transform: translateY(-1px);
        }

        .services-list {
            display: none;
        }

        .services-list.active {
            display: block;
        }

        .service-card {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 0;
            margin-bottom: 12px;
            border: 1px solid #2a2a2a;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
        }

        .service-card:hover {
            border-color: #0078D4;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 120, 212, 0.15);
        }

        .service-image {
            width: 100%;
            height: 150px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 32px;
            transition: all 0.3s ease;
        }

        .service-card:hover .service-image {
            transform: scale(1.05);
        }

        .service-details {
            padding: 16px;
        }

        .service-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .service-description {
            color: #888888;
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .service-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price {
            font-size: 18px;
            font-weight: 700;
            color: #0078D4;
        }

        /* Отзывы с анимацией */
        .reviews-header {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
        }

        .average-rating {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .rating-number {
            font-size: 24px;
            font-weight: 700;
        }

        .reviews-count {
            color: #888888;
            font-size: 14px;
        }

        .review-card {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }

        .review-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .review-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .reviewer-info {
            flex: 1;
        }

        .reviewer-name {
            display: block;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .review-date {
            color: #888888;
            font-size: 12px;
        }

        .review-rating {
            color: #ffd700;
            font-size: 14px;
        }

        .review-text {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Форма отзыва */
        .review-form {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
        }

        .review-form h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #0078D4;
        }

        .form-input, .form-textarea {
            width: 100%;
            background: #252525;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            padding: 12px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            color: #555;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #ffd700;
        }

        .star:hover {
            color: #ffd700;
        }

        /* Профиль */
        .profile-page {
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .user-profile {
            padding: 24px 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border-bottom: 1px solid #2a2a2a;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid #2a2a2a;
        }

        .profile-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .profile-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .profile-tab:hover::before {
            left: 100%;
        }

        .profile-tab.active {
            color: #0078D4;
            border-bottom-color: #0078D4;
        }

        .profile-tab:not(.active) {
            color: #888888;
        }

        .profile-tab:not(.active):hover {
            color: #ffffff;
        }

        .profile-content {
            padding: 20px;
            min-height: 200px;
        }

        .empty-state {
            text-align: center;
            color: #888888;
            padding: 40px 20px;
            animation: fadeInUp 0.6s ease-out;
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        .browse-services {
            background: #0078D4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .browse-services:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        /* Избранные услуги */
        .favorites-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .favorite-service-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .favorite-service-card:hover {
            border-color: #0078D4;
            transform: translateY(-2px);
        }

        .favorite-service-emoji {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #252525;
            border-radius: 8px;
        }

        .favorite-service-info {
            flex: 1;
        }

        .favorite-service-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .favorite-service-price {
            color: #0078D4;
            font-weight: 600;
        }

        .remove-favorite {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-favorite:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        /* Модальные окна с улучшенной анимацией */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
            animation: fadeInUp 0.3s ease-out;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid #2a2a2a;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
            animation: scaleIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888888;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: #2a2a2a;
            color: #ffffff;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(80vh - 80px);
            overflow-y: auto;
        }

        /* Модальное окно выбора времени */
        .time-selection {
            margin-bottom: 20px;
        }

        .date-selector {
            margin-bottom: 16px;
        }

        .date-buttons {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .date-btn {
            padding: 10px 16px;
            background: #252525;
            border: 1px solid #333333;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .date-btn.active {
            background: #0078D4;
            border-color: #0078D4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .date-btn:not(.active):hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .time-slot {
            padding: 12px 8px;
            background: #252525;
            border: 1px solid #333333;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .time-slot.active {
            background: #0078D4;
            border-color: #0078D4;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .time-slot.booked {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
            transform: scale(0.95);
        }

        .time-slot:not(.booked):not(.active):hover {
            background: #333333;
            transform: translateY(-2px);
        }

        /* Элементы корзины */
        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
            animation: fadeInUp 0.4s ease-out;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .cart-item-details {
            font-size: 14px;
            color: #888888;
        }

        .cart-item-price {
            font-size: 16px;
            font-weight: 600;
            color: #0078D4;
        }

        .remove-from-cart {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.3s ease;
        }

        .remove-from-cart:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .empty-cart {
            text-align: center;
            color: #888888;
            padding: 40px 20px;
            animation: fadeInUp 0.6s ease-out;
        }

        .cart-summary {
            border-top: 1px solid #2a2a2a;
            padding-top: 20px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }

        /* Новые стили для пожеланий и фото */
        .order-notes {
            margin: 16px 0;
            padding: 16px;
            background: #252525;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .order-notes h4 {
            margin-bottom: 12px;
            color: #0078D4;
        }

        #clientWishes {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            padding: 12px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 12px;
        }

        .photo-upload-section {
            text-align: center;
        }

        .photo-btn {
            background: #333;
            color: white;
            border: 1px dashed #555;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .photo-btn:hover {
            background: #444;
            border-color: #0078D4;
        }

        .photo-preview {
            margin-top: 12px;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #0078D4;
        }

        .prepayment-notice {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #cccccc;
            animation: fadeInUp 0.6s ease-out;
        }

        .checkout-btn {
            background: #0078D4;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .checkout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .checkout-btn:hover::before {
            left: 100%;
        }

        .checkout-btn:hover:not(:disabled) {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .checkout-btn:disabled {
            background: #333333;
            color: #888888;
            cursor: not-allowed;
            transform: scale(0.98);
        }

        /* Админ-панель */
        .admin-section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .admin-btn {
            background: #0078D4;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-btn:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .schedule-list {
            margin-top: 16px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
            animation: fadeInUp 0.4s ease-out;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        /* Статистика админки */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #0078D4, #005a9e);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #2a2a2a;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .stat-earnings {
            font-size: 14px;
            margin-top: 4px;
            opacity: 0.9;
        }

        .service-management, .content-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Стили для заказов в админке */
        .order-info {
            flex: 1;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .order-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-status.pending {
            background: #ffa500;
            color: black;
        }

        .order-status.confirmed {
            background: #00a86b;
            color: white;
        }

        .order-status.cancelled {
            background: #ff4444;
            color: white;
        }

        .service-line {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .order-wishes, .order-photo {
            font-size: 12px;
            color: #888;
            margin: 4px 0;
        }

        .order-total {
            font-weight: 600;
            margin-top: 8px;
        }

        .order-actions {
            display: flex;
            gap: 4px;
        }

        .status-btn {
            background: #333;
            border: none;
            color: white;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-btn:hover {
            background: #444;
            transform: scale(1.1);
        }

        /* Стили для уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0078D4;
            color: white;
            padding: 16px;
            border-radius: 12px;
            z-index: 2500;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.error {
            background: #ff4444;
        }

        .notification.success {
            background: #00a86b;
        }

        /* Стили для подтверждения действий */
        .confirmation-modal .modal-content {
            max-width: 350px;
        }

        .confirmation-text {
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            background: #ff4444;
        }

        .cancel-btn {
            flex: 1;
            background: #666;
        }

        /* Стили для кнопки удаления фото в галерее */
        .delete-photo-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .work-card:hover .delete-photo-btn {
            opacity: 1;
        }

        /* Стили для чата */
        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #0a0a0a;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        .message-group.client-group {
            align-items: flex-end;
        }

        .message-group.master-group {
            align-items: flex-start;
        }

        .date-divider {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }

        .date-divider::before,
        .date-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #2a2a2a;
        }

        .date-divider::before {
            left: 0;
        }

        .date-divider::after {
            right: 0;
        }

        .date-divider span {
            background: #1a1a1a;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            color: #888;
            position: relative;
            z-index: 1;
        }

        .message {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
            margin-bottom: 2px;
        }

        .message.client {
            background: #0078D4;
            border-bottom-right-radius: 4px;
        }

        .message.client:first-child {
            border-top-right-radius: 12px;
        }

        .message.client:last-child {
            border-bottom-right-radius: 12px;
        }

        .message.master {
            background: #2a2a2a;
            border-bottom-left-radius: 4px;
        }

        .message.master:first-child {
            border-top-left-radius: 12px;
        }

        .message.master:last-child {
            border-bottom-left-radius: 12px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 2px;
            text-align: right;
            padding-right: 4px;
        }

        .message.client .message-time {
            text-align: right;
        }

        .message.master .message-time {
            text-align: left;
        }

        .chat-input {
            display: flex;
            padding: 16px;
            border-top: 1px solid #2a2a2a;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            background: #252525;
            border: 1px solid #333;
            border-radius: 20px;
            color: white;
            padding: 12px 16px;
            font-size: 14px;
        }

        .send-btn {
            background: #0078D4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #005a9e;
        }

        .send-btn:disabled {
            background: #333;
            cursor: not-allowed;
        }

        /* Стили для индикаторов загрузки */
        .loading {
            position: relative;
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: -10px;
            margin-top: -10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            color: white;
            font-size: 18px;
        }

        /* Кнопка переключения режима */
        .mode-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #0078D4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .mode-toggle:hover {
            background: #005a9e;
            transform: scale(1.05);
        }

        /* Стили для редактора услуг */
        .editor-modal {
            max-width: 500px;
        }
        
        .editor-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-weight: 500;
            color: #0078D4;
        }
        
        .form-input, .form-textarea, .form-select {
            background: #252525;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            padding: 12px;
            font-size: 14px;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .save-btn {
            background: #00a86b;
            flex: 1;
        }
        
        .cancel-btn {
            background: #666;
            flex: 1;
        }
        
        .service-list-editor {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .service-editor-item {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #333;
        }
        
        .service-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .service-editor-name {
            font-weight: 600;
        }
        
        .service-editor-price {
            color: #0078D4;
            font-weight: 600;
        }
        
        .service-editor-actions {
            display: flex;
            gap: 6px;
        }
        
        .edit-btn {
            background: #0078D4;
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .delete-btn {
            background: #ff4444;
            padding: 6px 10px;
            font-size: 12px;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ ФОТО В ЧАТЕ */
        .chat-photo-message {
            max-width: 200px;
            border-radius: 12px;
            margin: 5px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .chat-photo-message:hover {
            transform: scale(1.05);
        }

        .photo-preview-chat {
            position: relative;
            display: inline-block;
        }

        .photo-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .photo-action-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .message-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            justify-content: flex-end;
        }

        /* Стили для настроек графика работы */
        .schedule-settings {
            margin-top: 16px;
        }

        .day-schedule {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .time-slots-input {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .time-input {
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            padding: 6px;
            width: 80px;
        }

        /* Стили для уведомлений о новых сообщениях */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item {
            position: relative;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ УПРАВЛЕНИЯ ЧАТОМ */
        .chat-management-stats {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #0078D4;
            font-weight: 600;
        }

        .storage-warning {
            background: #ffa500;
            color: black;
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 11px;
            text-align: center;
        }

        .storage-critical {
            background: #ff4444;
            color: white;
        }

        .chat-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        .chat-control-btn {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chat-control-btn:hover {
            background: #444;
            border-color: #0078D4;
        }

        .chat-control-btn.danger {
            background: #ff4444;
            border-color: #ff4444;
        }

        .chat-control-btn.danger:hover {
            background: #cc0000;
        }

        .compression-info {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 11px;
            color: #888;
        }

        /* Стили для индикатора загрузки сжатия */
        .compression-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ СИСТЕМЫ ЧАТОВ */
        .chats-list {
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .chat-item {
            padding: 16px;
            border-bottom: 1px solid #2a2a2a;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-item:hover {
            background: #252525;
        }
        
        .chat-item.active {
            background: #0078D4;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .chat-last-message {
            color: #888;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .chat-meta {
            text-align: right;
            font-size: 11px;
            color: #888;
        }
        
        .unread-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 4px;
        }
        
        .no-chats {
            padding: 40px 20px;
            text-align: center;
            color: #888;
        }
        
        .current-chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #252525;
            border-radius: 12px;
        }
        
        .back-to-chats {
            background: none;
            border: none;
            color: #0078D4;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ СИСТЕМЫ ЛОЯЛЬНОСТИ */
        .loyalty-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: black;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
            animation: heartBeat 2s infinite;
        }

        .loyalty-section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #2a2a2a;
            animation: fadeInUp 0.6s ease-out;
        }

        .loyalty-level {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .level-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .level-0 { background: linear-gradient(135deg, #cccccc, #999999); }
        .level-1 { background: linear-gradient(135deg, #b9f2ff, #00bfff); }
        .level-2 { background: linear-gradient(135deg, #ffb6c1, #ff69b4); }
        .level-3 { background: linear-gradient(135deg, #ffd700, #ffa500); }

        .level-info h3 {
            margin-bottom: 4px;
            font-size: 16px;
        }

        .level-info p {
            color: #888;
            font-size: 12px;
        }

        .progress-container {
            background: #333;
            border-radius: 10px;
            height: 8px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-0 { background: #cccccc; width: 0%; }
        .progress-1 { background: #00bfff; width: 33%; }
        .progress-2 { background: #ff69b4; width: 66%; }
        .progress-3 { background: #ffd700; width: 100%; }

        .discount-info {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            text-align: center;
        }

        .discount-amount {
            font-size: 24px;
            font-weight: 700;
            color: #00a86b;
            margin: 8px 0;
        }

        .original-price {
            text-decoration: line-through;
            color: #888;
            margin-right: 8px;
        }

        .discounted-price {
            color: #00a86b;
            font-weight: 600;
        }

        /* Адаптивность */
        @media (max-width: 380px) {
            .master-profile {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }
            
            .works-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .user-profile {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }

            .admin-controls {
                flex-direction: column;
            }

            .admin-btn {
                min-width: auto;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }

            .chat-controls {
                grid-template-columns: 1fr;
            }
            
            .chat-management-stats {
                font-size: 11px;
            }

            .chat-input {
                flex-wrap: wrap;
            }
            
            .chat-input input {
                min-width: 150px;
            }

            .chat-last-message {
                max-width: 150px;
            }
            
            .chat-item {
                padding: 12px;
            }
        }

        /* Дополнительные анимации для плавного появления элементов */
        .service-card:nth-child(1) { animation-delay: 0.1s; }
        .service-card:nth-child(2) { animation-delay: 0.2s; }
        .service-card:nth-child(3) { animation-delay: 0.3s; }
        .service-card:nth-child(4) { animation-delay: 0.4s; }

        .review-card:nth-child(1) { animation-delay: 0.1s; }
        .review-card:nth-child(2) { animation-delay: 0.2s; }
        .review-card:nth-child(3) { animation-delay: 0.3s; }

        .hit-card:nth-child(1) { animation-delay: 0.1s; }
        .hit-card:nth-child(2) { animation-delay: 0.2s; }
        .hit-card:nth-child(3) { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <!-- Кнопка переключения режима -->
    <button class="mode-toggle" id="modeToggle">Режим мастера</button>

    <div class="app">
        <!-- ОБНОВЛЕННАЯ ВЕРХНЯЯ НАВИГАЦИЯ (ИЗМЕНЕН ПОРЯДОК) -->
        <div class="top-nav">
            <div class="nav-item active" data-tab="main">Главная</div>
            <div class="nav-item" data-tab="services">Услуги</div>
            <div class="nav-item" data-tab="chat">Чат</div>
            <div class="nav-item" data-tab="reviews">Отзывы</div>
            <div class="nav-item" data-tab="profile">Профиль</div>
        </div>

        <!-- Главная страница -->
        <div class="tab-content active" id="main">
            <!-- Шапка профиля мастера -->
            <div class="master-profile">
                <div class="avatar-rect master-avatar">
                    <div class="avatar-content">Алёна</div>
                </div>
                <div class="master-info">
                    <h1>Алёна</h1>
                    <p>Персональный мастер • 4 года опыта</p>
                    <div class="rating">
                        <span class="stars">★★★★★</span>
                        <span class="rating-text">Оставьте ваш отзыв</span>
                    </div>
                </div>
            </div>

            <!-- Хиты продаж -->
            <div class="section">
                <div class="section-header">
                    <h2>Популярные услуги</h2>
                    <span class="see-all" onclick="switchToTab('services')">Все</span>
                </div>
                <div class="hits-scroll">
                    <div class="hits-container" id="popularServices">
                        <!-- Популярные услуги будут загружены динамически -->
                    </div>
                </div>
            </div>

            <!-- Примеры работ -->
            <div class="section">
                <div class="section-header">
                    <h2>Примеры работ</h2>
                    <span class="see-all">12 работ</span>
                </div>
                <div class="works-grid" id="worksGrid">
                    <!-- Работы будут загружены автоматически -->
                </div>
            </div>
        </div>

        <!-- Страница услуг -->
        <div class="tab-content" id="services">
            <div class="service-categories">
                <div class="service-category active" data-category="manicure">Маникюр</div>
                <div class="service-category" data-category="extension">Наращивание</div>
                <div class="service-category" data-category="correction">Коррекция</div>
            </div>

            <!-- Услуги маникюра -->
            <div class="services-list active" id="manicure-services">
                <!-- Услуги будут загружены динамически -->
            </div>

            <!-- Услуги наращивания -->
            <div class="services-list" id="extension-services">
                <!-- Услуги будут загружены динамически -->
            </div>

            <!-- Услуги коррекции -->
            <div class="services-list" id="correction-services">
                <!-- Услуги будут загружены динамически -->
            </div>
        </div>

        <!-- Вкладка: Чат -->
        <div class="tab-content" id="chat">
            <div class="section">
                <!-- ДЛЯ КЛИЕНТА: обычный чат -->
                <div id="clientChatView">
                    <h2>Чат с мастером</h2>
                    <p style="color: #888; margin-bottom: 16px;">Обсуждайте детали заказа напрямую</p>
                    
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message master">
                                <div>Добро пожаловать! Чем могу помочь?</div>
                                <div class="message-time">только что</div>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Введите сообщение..." maxlength="500">
                            <input type="file" id="chatPhotoInput" accept="image/*" style="display: none;">
                            <button class="send-btn" id="attachPhotoBtn">Вложить</button>
                            <button class="send-btn" id="sendMessageBtn">Отправить</button>
                        </div>
                    </div>
                </div>
                
                <!-- ДЛЯ МАСТЕРА: список чатов + выбранный чат -->
                <div id="masterChatView" style="display: none;">
                    <div id="chatsListView">
                        <h2>Чаты с клиентами</h2>
                        <div class="chats-list" id="chatsList">
                            <!-- Список чатов будет здесь -->
                        </div>
                        <div class="no-chats" id="noChatsMessage">
                            <p>Пока нет активных чатов</p>
                            <p style="font-size: 12px; margin-top: 8px;">Когда клиенты напишут вам, чаты появятся здесь</p>
                        </div>
                    </div>
                    
                    <div id="activeChatView" style="display: none;">
                        <div class="current-chat-header">
                            <button class="back-to-chats" id="backToChats">←</button>
                            <div class="chat-avatar" id="currentChatAvatar">К</div>
                            <div class="chat-info">
                                <div class="chat-name" id="currentChatName">Клиент</div>
                                <div class="chat-last-message" id="currentChatStatus">Online</div>
                            </div>
                        </div>
                        
                        <div class="chat-container">
                            <div class="chat-messages" id="masterChatMessages">
                                <!-- Сообщения выбранного чата -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="masterMessageInput" placeholder="Введите сообщение..." maxlength="500">
                                <input type="file" id="masterChatPhotoInput" accept="image/*" style="display: none;">
                                <button class="send-btn" id="masterAttachPhotoBtn">Вложить</button>
                                <button class="send-btn" id="masterSendMessageBtn">Отправить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Страница отзывов -->
        <div class="tab-content" id="reviews">
            <div class="reviews-header">
                <h2>Отзывы клиентов</h2>
                <div class="average-rating">
                    <span class="rating-number">-</span>
                    <span class="stars">★★★★★</span>
                    <span class="reviews-count">0 отзывов</span>
                </div>
            </div>

            <!-- Форма для оставления отзыва (УБРАНО ПОЛЕ ИМЕНИ) -->
            <div class="review-form">
                <h3>Оставьте ваш отзыв</h3>
                <form id="reviewForm">
                    <div class="form-group">
                        <label>Ваша оценка:</label>
                        <div class="rating-stars">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        <input type="hidden" id="selectedRating" required>
                    </div>
                    <div class="form-group">
                        <label for="reviewText">Ваш отзыв:</label>
                        <textarea id="reviewText" class="form-textarea" placeholder="Расскажите о вашем опыте..." rows="4" required></textarea>
                    </div>
                    <button type="submit" class="checkout-btn">Оставить отзыв</button>
                </form>
            </div>

            <!-- Список отзывов -->
            <div id="reviewsContainer">
                <!-- Отзывы будут загружены динамически -->
            </div>
        </div>

        <!-- Страница профиля -->
        <div class="tab-content" id="profile">
            <div class="profile-page">
                <div class="user-profile">
                    <div class="avatar-rect user-avatar" id="userAvatar">
                        <div class="avatar-content">Клиент</div>
                    </div>
                    <div class="user-info">
                        <h2 id="userName">Клиент</h2>
                        <p id="userUsername">Ваш профиль</p>
                        <p id="userRole">Клиент</p>
                    </div>
                </div>

                <div class="profile-tabs">
                    <div class="profile-tab active" data-profile-tab="appointments">Мои записи</div>
                    <div class="profile-tab" data-profile-tab="favorites">Избранное</div>
                    <div class="profile-tab" data-profile-tab="loyalty">Система лояльности</div>
                    <div class="profile-tab" data-profile-tab="admin" id="adminTab" style="display: none;">Админ-панель</div>
                </div>

                <div class="profile-content">
                    <!-- Вкладка "Мои записи" с подвкладками -->
                    <div id="appointmentsContent">
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #2a2a2a;">
                            <button class="profile-tab" data-appointments-tab="active" style="flex: 1; padding: 12px; border: none; background: transparent; color: #0078D4; border-bottom: 2px solid #0078D4; cursor: pointer;">
                                Активные записи
                            </button>
                            <button class="profile-tab" data-appointments-tab="history" style="flex: 1; padding: 12px; border: none; background: transparent; color: #888; border-bottom: 2px solid transparent; cursor: pointer;">
                                История записей
                            </button>
                        </div>
                        <div id="activeAppointmentsContent">
                            <!-- Активные записи будут здесь -->
                        </div>
                        <div id="historyAppointmentsContent" style="display: none;">
                            <!-- История записей будет здесь -->
                        </div>
                    </div>

                    <div class="empty-state" id="favoritesContent" style="display: none;">
                        <p>У вас пока нет избранных услуг</p>
                        <button class="browse-services" onclick="switchToTab('services')">Найти услуги</button>
                    </div>

                    <!-- НОВАЯ ВКЛАДКА: СИСТЕМА ЛОЯЛЬНОСТИ -->
                    <div id="loyaltyContent" style="display: none;">
                        <div class="loyalty-section">
                            <div class="loyalty-level">
                                <div class="level-icon" id="currentLevelIcon">0</div>
                                <div class="level-info">
                                    <h3 id="currentLevelName">Начинающий</h3>
                                    <p id="levelDescription">Следующий уровень: <span id="nextLevelName">Знаток в маникюре</span></p>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar" id="levelProgress"></div>
                            </div>
                            
                            <div style="text-align: center; margin: 16px 0;">
                                <p>Ваши визиты: <strong id="totalVisits">0</strong></p>
                                <p>До следующего уровня: <strong id="visitsToNext">3</strong> визитов</p>
                            </div>
                            
                            <div class="discount-info">
                                <p>Текущая скидка</p>
                                <div class="discount-amount" id="currentDiscount">0%</div>
                                <p id="discountDescription">Следующая скидка активируется автоматически</p>
                            </div>
                        </div>

                        <div class="loyalty-section">
                            <h3>Уровни системы лояльности</h3>
                            
                            <div class="loyalty-level">
                                <div class="level-icon level-0">1</div>
                                <div class="level-info">
                                    <h3>Начинающий <span class="loyalty-badge">0%</span></h3>
                                    <p>3 визита для перехода на следующий уровень</p>
                                </div>
                            </div>
                            
                            <div class="loyalty-level">
                                <div class="level-icon level-1">2</div>
                                <div class="level-info">
                                    <h3>Знаток в маникюре <span class="loyalty-badge">5%</span></h3>
                                    <p>Каждое 3-е посещение со скидкой 5% (2 цикла)</p>
                                </div>
                            </div>
                            
                            <div class="loyalty-level">
                                <div class="level-icon level-2">3</div>
                                <div class="level-info">
                                    <h3>Фанатка nailsq <span class="loyalty-badge">10%</span></h3>
                                    <p>Каждое 3-е посещение со скидкой 10% (3 цикла)</p>
                                </div>
                            </div>
                            
                            <div class="loyalty-level">
                                <div class="level-icon level-3">4</div>
                                <div class="level-info">
                                    <h3>Элита nailsq <span class="loyalty-badge">15%</span></h3>
                                    <p>Каждое 3-е посещение со скидкой 15% (бесконечно)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="adminContent" style="display: none;">
                        <!-- ОБНОВЛЕННАЯ АДМИН-ПАНЕЛЬ С УПРАВЛЕНИЕМ ЧАТОМ -->
                        <div class="admin-section">
                            <h3>Панель управления</h3>
                            
                            <div class="admin-controls" id="statsControls" style="margin-top: 10px;">
                                <button class="admin-btn" onclick="openStatsSettings()">Настройки</button>
                                <button class="admin-btn" onclick="showCustomPeriodStats()">Произв. период</button>
                                <button class="admin-btn" onclick="exportStats()">Экспорт</button>
                            </div>
                            
                            <div class="admin-stats" id="adminStatsContainer">
                                <!-- Статистика будет загружена здесь -->
                            </div>
                        </div>

                        <!-- НОВЫЙ РАЗДЕЛ: УПРАВЛЕНИЕ ЧАТОМ -->
                        <div class="admin-section">
                            <h3>Управление историей чата</h3>
                            
                            <div class="chat-management-stats" id="chatStats">
                                <!-- Статистика чата будет здесь -->
                            </div>

                            <div class="chat-controls">
                                <button class="chat-control-btn" onclick="exportChatHistory()">Экспорт чата</button>
                                <button class="chat-control-btn" onclick="showChatSettings()">Настройки</button>
                                <button class="chat-control-btn" onclick="clearOldMessages()">Очистить старые</button>
                                <button class="chat-control-btn" onclick="openChatManager()">Управление чатами</button>
                                <button class="chat-control-btn danger" onclick="clearEntireChat()">Очистить всё</button>
                            </div>

                            <div class="compression-info">
                                Фото автоматически сжимаются для экономии места
                            </div>
                        </div>

                        <!-- НОВЫЙ РАЗДЕЛ: НАСТРОЙКА ГРАФИКА РАБОТЫ -->
                        <div class="admin-section">
                            <h3>График работы</h3>
                            <div class="admin-controls">
                                <button class="admin-btn" onclick="openScheduleSettings()">Настроить график</button>
                                <button class="admin-btn" onclick="setDefaultSchedule()">Стандартный</button>
                            </div>
                            <div class="schedule-preview" id="schedulePreview">
                                <!-- Предпросмотр графика будет здесь -->
                            </div>
                        </div>

                        <!-- НОВЫЙ РАЗДЕЛ: УПРАВЛЕНИЕ СВОБОДНЫМ ВРЕМЕНЕМ -->
                        <div class="admin-section">
                            <h3>⏰ Управление свободным временем</h3>
                            <div class="admin-controls">
                                <button class="admin-btn" onclick="openFreeTimeManager()">➕ Добавить свободное время</button>
                                <button class="admin-btn" onclick="viewFreeTimeSlots()">📋 Просмотр слотов</button>
                            </div>
                            <div id="freeTimePreview" style="margin-top: 12px; padding: 12px; background: #252525; border-radius: 8px; font-size: 12px; color: #888;">
                                <!-- Предпросмотр свободного времени -->
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3>📅 Активные записи</h3>
                            <div class="admin-controls">
                                <button class="admin-btn" onclick="clearAllBookings()">🗑️ Очистить все</button>
                                <button class="admin-btn" onclick="addTestBookings()">🧪 Тестовые данные</button>
                                <button class="admin-btn" onclick="exportSchedule()">📤 Экспорт</button>
                            </div>
                            <div class="schedule-list" id="scheduleList"></div>
                        </div>

                        <div class="admin-section">
                            <h3>⚙️ Управление услугами</h3>
                            <div class="service-management">
                                <button class="admin-btn" onclick="openServiceEditor()">✏️ Редактировать услуги</button>
                                <button class="admin-btn" onclick="openPriceEditor()">💰 Изменить цены</button>
                                <button class="admin-btn" onclick="addNewService()">➕ Новая услуга</button>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3>🖼️ Управление контентом</h3>
                            <div class="content-management">
                                <button class="admin-btn" onclick="openPhotoManager()">📸 Фото работ</button>
                                <button class="admin-btn" onclick="changeMasterPhoto()">👤 Фото профиля</button>
                                <button class="admin-btn" onclick="manageServicePhotos()">🖼️ Фото услуг</button>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3>💬 Настройки сообщений</h3>
                            <div class="admin-controls">
                                <button class="admin-btn" onclick="openApprovalSettings()">⚙️ Настроить сообщения</button>
                            </div>
                            <div id="approvalSettingsPreview" style="margin-top: 12px; padding: 12px; background: #252525; border-radius: 8px; font-size: 12px; color: #888;">
                                <p>📍 Адрес: <strong style="color: #fff;" id="previewAddress">Загрузка...</strong></p>
                                <p>💳 Реквизиты: <strong style="color: #fff;" id="previewPayment">Загрузка...</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальные окна -->
        <div class="modal" id="timeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Выберите время</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="time-selection">
                        <div class="date-selector">
                            <h4>Выберите дату:</h4>
                            <div class="date-buttons" id="dateButtons"></div>
                        </div>
                        <div class="time-selector">
                            <h4>Выберите время:</h4>
                            <div class="time-slots" id="timeSlots"></div>
                        </div>
                    </div>
                    <button class="checkout-btn" id="confirmTimeBtn">Подтвердить время</button>
                </div>
            </div>
        </div>

        <div class="modal" id="cartModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Корзина</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="cart-items" id="cartItems">
                        <div class="empty-cart">
                            <p>Корзина пуста</p>
                        </div>
                    </div>
                    
                    <div class="order-notes">
                        <h4>Ваши пожелания:</h4>
                        <textarea id="clientWishes" placeholder="Например: Хочу френч с розовым оттенком..." rows="3"></textarea>
                        
                        <div class="photo-upload-section">
                            <input type="file" id="photoReference" accept="image/*" style="display: none;">
                            <button type="button" id="addPhotoBtn" class="photo-btn">
                                Прикрепить фото примера
                            </button>
                            <div id="photoPreview" class="photo-preview"></div>
                        </div>
                    </div>
                    
                    <div class="cart-summary">
                        <div class="prepayment-notice" style="background: #2a1a1a; border-left: 3px solid #ff4444;">
                            <b>Предоплата:</b> 500 ₽ переводом на банковский счет
                            <div style="margin-top: 8px; font-size: 12px; color: #ff8888;">
                                <b>Внимание:</b> Предоплата возвращается только по важным причинам и не менее чем за три дня до записи. Предоплата включена в стоимость услуги.
                            </div>
                        </div>
                        <div class="total-line">
                            <span>Итого:</span>
                            <span id="modalTotal">0 ₽</span>
                        </div>
                        <button class="checkout-btn" id="checkoutBtn" disabled>Оформить запись</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальные окна админ-панели -->
        <div class="modal" id="photoManagerModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Галерея работ</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="works-grid" id="worksGallery">
                        <!-- Фото работ будут здесь -->
                    </div>
                    <button class="admin-btn" onclick="addWorkPhoto()" style="width: 100%; margin-top: 16px;">Добавить фото</button>
                </div>
            </div>
        </div>

        <!-- НОВОЕ МОДАЛЬНОЕ ОКНО: НАСТРОЙКА ГРАФИКА РАБОТЫ -->
        <div class="modal" id="scheduleSettingsModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Настройка графика работы</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="schedule-settings" id="scheduleSettings">
                        <!-- Настройки графика будут здесь -->
                    </div>
                    <div class="form-actions">
                        <button class="cancel-btn checkout-btn" onclick="closeScheduleSettings()">Отмена</button>
                        <button class="save-btn checkout-btn" onclick="saveScheduleSettings()">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- НОВОЕ МОДАЛЬНОЕ ОКНО: НАСТРОЙКИ ЧАТА -->
        <div class="modal" id="chatSettingsModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Настройки чата</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="editor-form">
                        <div class="form-group">
                            <label>Максимум сообщений:</label>
                            <input type="number" id="maxMessages" class="form-input" min="50" max="1000">
                            <small style="color: #888;">Рекомендуется: 200-500 сообщений</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Максимум дней хранения:</label>
                            <input type="number" id="maxDays" class="form-input" min="7" max="365">
                            <small style="color: #888;">Сообщения старше этого срока будут удалены</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Максимум фото:</label>
                            <input type="number" id="maxPhotos" class="form-input" min="10" max="200">
                            <small style="color: #888;">Рекомендуется: 30-50 фото</small>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="compressImages">
                                Сжимать изображения
                            </label>
                            <small style="color: #888;">Уменьшает размер фото в 3-5 раз</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Качество сжатия (%):</label>
                            <input type="range" id="imageQuality" min="10" max="90" step="10" class="form-input">
                            <small style="color: #888;">Текущее: <span id="qualityValue">70%</span></small>
                        </div>

                        <div class="form-actions">
                            <button class="cancel-btn checkout-btn" onclick="closeChatSettings()">Отмена</button>
                            <button class="save-btn checkout-btn" onclick="saveChatSettings()">Сохранить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно настроек сообщений об одобрении -->
        <div class="modal" id="approvalSettingsModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Настройки сообщений об одобрении</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="editor-form">
                        <div class="form-group">
                            <label>Сообщение об одобрении:</label>
                            <textarea id="approvedMessageText" class="form-textarea" rows="8" placeholder="Используйте переменные: {date}, {time}, {services}, {address}, {payment}"></textarea>
                            <small style="color: #888;">Переменные: {date} - дата, {time} - время, {services} - список услуг, {address} - адрес, {payment} - реквизиты</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Сообщение об отклонении:</label>
                            <textarea id="rejectedMessageText" class="form-textarea" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Адрес:</label>
                            <input type="text" id="approvalAddress" class="form-input" placeholder="Укажите адрес">
                        </div>
                        
                        <div class="form-group">
                            <label>Реквизиты для оплаты:</label>
                            <textarea id="approvalPayment" class="form-textarea" rows="3" placeholder="Номер карты, СБП, или другие реквизиты"></textarea>
                        </div>

                        <div class="form-actions">
                            <button class="cancel-btn checkout-btn" onclick="closeApprovalSettings()">Отмена</button>
                            <button class="save-btn checkout-btn" onclick="saveApprovalSettings()">Сохранить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно управления свободным временем -->
        <div class="modal" id="freeTimeModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Управление свободным временем</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="editor-form">
                        <div class="form-group">
                            <label>Дата:</label>
                            <input type="date" id="freeTimeDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Время начала:</label>
                            <input type="time" id="freeTimeStart" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Время окончания:</label>
                            <input type="time" id="freeTimeEnd" class="form-input">
                        </div>
                        <div class="form-actions">
                            <button class="cancel-btn checkout-btn" onclick="closeFreeTimeManager()">Отмена</button>
                            <button class="save-btn checkout-btn" onclick="saveFreeTimeSlot()">Сохранить</button>
                        </div>
                    </div>
                    <div id="freeTimeSlotsList" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                        <!-- Список свободных слотов -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно управления чатами -->
        <div class="modal" id="chatManagerModal">
            <div class="modal-content editor-modal">
                <div class="modal-header">
                    <h3>Управление чатами</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="chatsManagerList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Список чатов для управления -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Индикатор загрузки -->
        <div class="loading-overlay" id="globalLoading" style="display: none;">
            <div style="text-align: center;">
                <div class="loading" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                <div>Загрузка...</div>
            </div>
        </div>
    </div>

    <script>
        // ========== TELEGRAM INIT ==========
        console.log('Initializing Telegram WebApp...');
        const tg = window.Telegram.WebApp;
        
        // Расширяем на весь экран
        tg.expand();
        
        // Говорим Telegram что приложение готово
        tg.ready();
        
        // Получаем данные пользователя
        const user = tg.initDataUnsafe?.user;
        console.log('Telegram User:', user);
        
        // ========== БЕЗОПАСНОСТЬ: ID МАСТЕРА ==========
        const MASTER_TELEGRAM_ID = 1346221717;
        
        // Проверка доступа к режиму мастера
        function checkMasterAccess() {
            if (!user || !user.id) {
                return false;
            }
            return String(user.id) === String(MASTER_TELEGRAM_ID);
        }
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let cart = [];
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let clientWishes = '';
        let referencePhoto = null;
        // Проверяем доступ перед установкой режима мастера
        let isMaster = false;
        const storedMasterMode = localStorage.getItem('isMaster') === 'true';
        if (storedMasterMode && checkMasterAccess()) {
            isMaster = true;
        } else if (storedMasterMode && !checkMasterAccess()) {
            // Если кто-то пытался включить режим мастера без доступа, сбрасываем
            localStorage.setItem('isMaster', 'false');
            isMaster = false;
        }
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        // Система учета заработка
        let earningsStats = JSON.parse(localStorage.getItem('earningsStats')) || {
            daily: {},
            weekly: {},
            monthly: {},
            total: 0
        };

        // Галерея работ
        let worksGallery = JSON.parse(localStorage.getItem('worksGallery')) || [
            "https://via.placeholder.com/150/FF6B6B/FFFFFF?text=Work+1",
            "https://via.placeholder.com/150/4ECDC4/FFFFFF?text=Work+2", 
            "https://via.placeholder.com/150/45B7D1/FFFFFF?text=Work+3",
            "https://via.placeholder.com/150/96CEB4/FFFFFF?text=Work+4",
            "https://via.placeholder.com/150/F7DC6F/FFFFFF?text=Work+5",
            "https://via.placeholder.com/150/BB8FCE/FFFFFF?text=Work+6"
        ];

        // Отзывы
        let reviews = JSON.parse(localStorage.getItem('reviews')) || [];

        // Забронированные времена
        let bookedSlots = JSON.parse(localStorage.getItem('bookedSlots')) || [];

        // База данных услуг
        let servicesData = JSON.parse(localStorage.getItem('servicesData')) || {
            manicure: [
                {
                    id: 1,
                    name: "Маникюр + покрытие",
                    description: "Полный комплекс: обработка, покрытие гель-лаком, укрепление. Идеально ровное покрытие на 3-4 недели.",
                    price: 1900,
                    duration: 120,
                    emoji: "💅",
                    category: "manicure"
                },
                {
                    id: 2,
                    name: "Маникюр без покрытия",
                    description: "Опил формы, обработка кутикулы, полировка. Идеальная подготовка ногтей.",
                    price: 600,
                    duration: 45,
                    emoji: "💅",
                    category: "manicure"
                }
            ],
            extension: [
                {
                    id: 3,
                    name: "Наращивание до 3",
                    description: "Наращивание гелем на формы, идеальная форма, любой дизайн включен в стоимость.",
                    price: 2500,
                    duration: 210,
                    emoji: "✨",
                    category: "extension"
                },
                {
                    id: 4,
                    name: "Наращивание до 8",
                    description: "Наращивание средней длины, прочное покрытие, сложный дизайн включен.",
                    price: 2800,
                    duration: 210,
                    emoji: "✨",
                    category: "extension"
                }
            ],
            correction: [
                {
                    id: 5,
                    name: "Коррекция до 3",
                    description: "Коррекция нарощенных ногтей, обработка, новое покрытие с дизайном.",
                    price: 2100,
                    duration: 210,
                    emoji: "🔧",
                    category: "correction"
                },
                {
                    id: 6,
                    name: "Коррекция до 8",
                    description: "Коррекция средней длины, укрепление, обновление дизайна.",
                    price: 2400,
                    duration: 210,
                    emoji: "🔧",
                    category: "correction"
                },
                {
                    id: 7,
                    name: "Ремонт моей работы",
                    description: "Бесплатный ремонт в течение 3 дней после выполнения услуги. Только для моих клиентов.",
                    price: 0,
                    duration: 30,
                    emoji: "🔧",
                    category: "correction"
                },
                {
                    id: 8,
                    name: "Ремонт чужой работы",
                    description: "Исправление работы другого мастера. Восстановление сломанных ногтей, коррекция формы.",
                    price: 300,
                    duration: 30,
                    emoji: "🔧",
                    category: "correction"
                }
            ]
        };

        // Настройки статистики
        let statsSettings = JSON.parse(localStorage.getItem('statsSettings')) || {
            today: true,
            week: true, 
            month: true,
            total: true
        };

        // НОВЫЕ ПЕРЕМЕННЫЕ: Настройки графика работы
        let workSchedule = JSON.parse(localStorage.getItem('workSchedule')) || {
            monday: { enabled: true, start: "10:00", end: "20:00" },
            tuesday: { enabled: true, start: "10:00", end: "20:00" },
            wednesday: { enabled: true, start: "10:00", end: "20:00" },
            thursday: { enabled: true, start: "10:00", end: "20:00" },
            friday: { enabled: true, start: "10:00", end: "20:00" },
            saturday: { enabled: false, start: "10:00", end: "18:00" },
            sunday: { enabled: false, start: "10:00", end: "18:00" }
        };

        // Настройки сообщений об одобрении
        let             approvalSettings = JSON.parse(localStorage.getItem('approvalSettings')) || {
            approvedMessage: `Ваша запись подтверждена!\n\nДата и время:\n{date} в {time}\n\nУслуга:\n{services}\n\nАдрес:\n{address}\n\nРеквизиты для оплаты:\n{payment}\n\nЖдем вас!`,
            rejectedMessage: `К сожалению, ваша запись не может быть подтверждена в указанное время. Пожалуйста, выберите другое время или свяжитесь с нами.`,
            address: "Укажите адрес в настройках",
            payment: "Укажите реквизиты в настройках"
        };

        // ========== КОНФИГУРАЦИЯ ЧАТА ==========
        const CHAT_CONFIG = {
            MAX_MESSAGES: 200,
            MAX_DAYS: 30,
            MAX_PHOTOS: 50,
            COMPRESS_IMAGES: true,
            IMAGE_QUALITY: 0.7,
            MAX_IMAGE_WIDTH: 800,
            MAX_STORAGE_SIZE: 5 * 1024 * 1024 // 5MB
        };

        // Загружаем настройки из localStorage
        const savedConfig = JSON.parse(localStorage.getItem('chatConfig'));
        if (savedConfig) {
            Object.assign(CHAT_CONFIG, savedConfig);
        }

        // Текущая редактируемая услуга
        let currentEditingService = null;

        // ========== СИСТЕМА МНОЖЕСТВЕННЫХ ЧАТОВ ==========
        
        // Структура для хранения чатов
        let chats = JSON.parse(localStorage.getItem('chats')) || {};
        let currentChatId = null;
        
        // Инициализация системы чатов
        function initChatSystem() {
            if (isMaster) {
                // Показываем интерфейс мастера
                document.getElementById('clientChatView').style.display = 'none';
                document.getElementById('masterChatView').style.display = 'block';
                renderChatsList();
            } else {
                // Показываем интерфейс клиента
                const clientId = getClientId();
                const hasApprovedOrder = checkClientHasApprovedOrder(clientId);
                
                if (hasApprovedOrder) {
                    // Если есть одобренная запись, показываем чат
                    document.getElementById('clientChatView').style.display = 'block';
                    document.getElementById('masterChatView').style.display = 'none';
                    
                    if (!chats[clientId]) {
                        createNewChat(clientId);
                    }
                    currentChatId = clientId;
                    renderChatMessages();
                } else {
                    // Если нет одобренной записи, показываем сообщение
                    document.getElementById('clientChatView').style.display = 'block';
                    document.getElementById('masterChatView').style.display = 'none';
                    showChatWaitingMessage();
                }
            }
        }

        // Проверка наличия одобренной записи у клиента
        function checkClientHasApprovedOrder(clientId) {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const clientOrders = getClientOrders();
            
            // Проверяем есть ли хотя бы одна одобренная запись
            return clientOrders.some(order => order.approved === true);
        }

        // Показ сообщения об ожидании одобрения
        function showChatWaitingMessage() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
                    container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #888;">
                    <h3 style="margin-bottom: 12px;">Чат будет доступен после одобрения записи</h3>
                    <p style="font-size: 14px; line-height: 1.5;">
                        После того как мастер подтвердит вашу запись, здесь появится возможность общаться с мастером.
                    </p>
                </div>
            `;
            
            // Блокируем поле ввода
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageBtn');
            const attachBtn = document.getElementById('attachPhotoBtn');
            
            if (messageInput) {
                messageInput.disabled = true;
                messageInput.placeholder = 'Чат будет доступен после одобрения записи';
            }
            if (sendBtn) sendBtn.disabled = true;
            if (attachBtn) attachBtn.disabled = true;
        }
        
        // Получение ID клиента
        function getClientId() {
            if (user && user.id) {
                return `client_${user.id}`;
            }
            // Если нет данных Telegram, используем случайный ID
            let clientId = localStorage.getItem('clientId');
            if (!clientId) {
                clientId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('clientId', clientId);
            }
            return clientId;
        }
        
        // Создание нового чата
        function createNewChat(clientId, clientName = null) {
            const clientInfo = {
                id: clientId,
                name: clientName || (user ? (user.first_name || `Клиент ${clientId.slice(-4)}`) : `Клиент ${clientId.slice(-4)}`),
                username: user?.username ? `@${user.username}` : null,
                avatarColor: getRandomGradient(),
                created: new Date().toISOString(),
                lastActivity: new Date().toISOString(),
                unreadCount: 0
            };
            
            chats[clientId] = {
                info: clientInfo,
                messages: [
                    {
                        id: Date.now(),
                        text: "Добро пожаловать! Чем могу помочь?",
                        sender: 'master',
                        timestamp: new Date().toISOString(),
                        read: false
                    }
                ]
            };
            
            saveChats();
            return clientId;
        }
        
        // Рендер списка чатов для мастера
        function renderChatsList() {
            const container = document.getElementById('chatsList');
            const noChats = document.getElementById('noChatsMessage');
            
            if (Object.keys(chats).length === 0) {
                container.innerHTML = '';
                noChats.style.display = 'block';
                return;
            }
            
            noChats.style.display = 'none';
            
            let html = '';
            Object.values(chats)
                .sort((a, b) => new Date(b.info.lastActivity) - new Date(a.info.lastActivity))
                .forEach(chat => {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    const lastMessageText = lastMessage?.photo ? 'Фото' : (lastMessage?.text || 'Нет сообщений');
                    const lastMessageTime = lastMessage ? formatTime(lastMessage.timestamp) : '';
                    
                    html += `
                        <div class="chat-item" data-chat-id="${chat.info.id}" onclick="openChat('${chat.info.id}')">
                            <div class="chat-avatar" style="background: ${chat.info.avatarColor}">
                                ${chat.info.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="chat-info">
                                <div class="chat-name">${chat.info.name}</div>
                                <div class="chat-last-message">${lastMessageText}</div>
                            </div>
                            <div class="chat-meta">
                                <div>${lastMessageTime}</div>
                                ${chat.info.unreadCount > 0 ? 
                                    `<div class="unread-badge">${chat.info.unreadCount}</div>` : 
                                    '<div style="height: 18px;"></div>'
                                }
                            </div>
                        </div>
                    `;
                });
            
            container.innerHTML = html;
        }
        
        // Открытие чата для мастера
        function openChat(chatId) {
            currentChatId = chatId;
            
            // Сбрасываем счетчик непрочитанных
            if (chats[chatId]) {
                chats[chatId].info.unreadCount = 0;
                saveChats();
            }
            
            // Переключаем вид
            document.getElementById('chatsListView').style.display = 'none';
            document.getElementById('activeChatView').style.display = 'block';
            
            // Заполняем информацию о чате
            const chat = chats[chatId];
            document.getElementById('currentChatName').textContent = chat.info.name;
            document.getElementById('currentChatAvatar').textContent = chat.info.name.charAt(0).toUpperCase();
            document.getElementById('currentChatAvatar').style.background = chat.info.avatarColor;
            document.getElementById('currentChatStatus').textContent = getLastSeen(chat.info.lastActivity);
            
            // Рендерим сообщения
            renderMasterChatMessages();
        }
        
        // Возврат к списку чатов
        function backToChatsList() {
            document.getElementById('chatsListView').style.display = 'block';
            document.getElementById('activeChatView').style.display = 'none';
            currentChatId = null;
            renderChatsList();
        }
        
        // Группировка сообщений для отображения как в Telegram
        function groupMessages(messages) {
            if (!messages || messages.length === 0) return [];
            
            const grouped = [];
            let currentGroup = null;
            let lastDate = null;
            
            messages.forEach((msg, index) => {
                const msgDate = new Date(msg.timestamp);
                const msgDateStr = msgDate.toLocaleDateString('ru-RU');
                const prevMsg = index > 0 ? messages[index - 1] : null;
                const prevDate = prevMsg ? new Date(prevMsg.timestamp).toLocaleDateString('ru-RU') : null;
                
                // Добавляем разделитель даты если дата изменилась
                if (msgDateStr !== prevDate) {
                    lastDate = msgDateStr;
                }
                
                // Проверяем нужно ли создать новую группу
                const shouldStartNewGroup = !currentGroup || 
                    currentGroup.sender !== msg.sender ||
                    (prevMsg && (msgDate - new Date(prevMsg.timestamp)) > 5 * 60000); // 5 минут разница
                
                if (shouldStartNewGroup) {
                    if (currentGroup) {
                        grouped.push(currentGroup);
                    }
                    currentGroup = {
                        sender: msg.sender,
                        messages: [msg],
                        date: msgDateStr
                    };
                } else {
                    currentGroup.messages.push(msg);
                }
            });
            
            if (currentGroup) {
                grouped.push(currentGroup);
            }
            
            return { grouped, lastDate };
        }

        // Рендер сообщений для мастера
        function renderMasterChatMessages() {
            const container = document.getElementById('masterChatMessages');
            if (!currentChatId || !chats[currentChatId]) return;
            
            const messages = chats[currentChatId].messages;
            container.innerHTML = '';
            
            const { grouped, lastDate } = groupMessages(messages);
            let lastDisplayedDate = null;
            
            grouped.forEach((group, groupIndex) => {
                // Добавляем разделитель даты
                if (group.date !== lastDisplayedDate) {
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const dateObj = new Date(group.messages[0].timestamp);
                    const dateText = dateObj.toLocaleDateString('ru-RU', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    });
                    dateDivider.innerHTML = `<span>${dateText}</span>`;
                    container.appendChild(dateDivider);
                    lastDisplayedDate = group.date;
                }
                
                // Создаем группу сообщений
                const groupDiv = document.createElement('div');
                groupDiv.className = `message-group ${group.sender}-group`;
                
                group.messages.forEach((msg, msgIndex) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender}`;
                    messageDiv.setAttribute('data-message-id', msg.id);
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let messageContent = '';
                    if (msg.photo) {
                        messageContent = `
                            <div class="photo-preview-chat">
                                <img src="${msg.photo}" class="chat-photo-message" onclick="viewPhoto('${msg.photo}')">
                                <div class="photo-actions">
                                    <button class="photo-action-btn" onclick="downloadPhoto('${msg.photo}')">⤵️</button>
                                </div>
                            </div>
                        `;
                    }
                    if (msg.text) {
                        const isEdited = msg.edited ? ' <span style="font-size: 10px; opacity: 0.7;">(изменено)</span>' : '';
                        messageContent += `<div class="message-text" data-msg-id="${msg.id}">${msg.text}${isEdited}</div>`;
                    }
                    
                    // Кнопки действий (только для своих сообщений и не системных)
                    let actionButtons = '';
                    if (msg.sender === 'master' && !msg.isSystem) {
                        actionButtons = `
                            <div class="message-actions" style="display: none; gap: 4px; margin-top: 4px;">
                                <button class="photo-action-btn" onclick="editMessage(${msg.id}, '${currentChatId}')" title="Редактировать">✏️</button>
                                <button class="photo-action-btn" onclick="deleteMessage(${msg.id}, '${currentChatId}')" title="Удалить">🗑️</button>
                            </div>
                        `;
                    }
                    
                    messageDiv.innerHTML = `
                        ${messageContent}
                        <div class="message-time">${time}${actionButtons}</div>
                    `;
                    
                    // Показываем кнопки при наведении
                    messageDiv.addEventListener('mouseenter', function() {
                        const actions = this.querySelector('.message-actions');
                        if (actions) actions.style.display = 'flex';
                    });
                    messageDiv.addEventListener('mouseleave', function() {
                        const actions = this.querySelector('.message-actions');
                        if (actions) actions.style.display = 'none';
                    });
                    
                    groupDiv.appendChild(messageDiv);
                });
                
                container.appendChild(groupDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // Рендер сообщений для клиента
        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!currentChatId || !chats[currentChatId]) return;
            
            const messages = chats[currentChatId].messages;
            container.innerHTML = '';
            
            const { grouped, lastDate } = groupMessages(messages);
            let lastDisplayedDate = null;
            
            grouped.forEach((group, groupIndex) => {
                // Добавляем разделитель даты
                if (group.date !== lastDisplayedDate) {
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const dateObj = new Date(group.messages[0].timestamp);
                    const dateText = dateObj.toLocaleDateString('ru-RU', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    });
                    dateDivider.innerHTML = `<span>${dateText}</span>`;
                    container.appendChild(dateDivider);
                    lastDisplayedDate = group.date;
                }
                
                // Создаем группу сообщений
                const groupDiv = document.createElement('div');
                groupDiv.className = `message-group ${group.sender}-group`;
                
                group.messages.forEach((msg, msgIndex) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender}`;
                    messageDiv.setAttribute('data-message-id', msg.id);
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let messageContent = '';
                    if (msg.photo) {
                        messageContent = `
                            <div class="photo-preview-chat">
                                <img src="${msg.photo}" class="chat-photo-message" onclick="viewPhoto('${msg.photo}')">
                                <div class="photo-actions">
                                    <button class="photo-action-btn" onclick="downloadPhoto('${msg.photo}')">⤵️</button>
                                </div>
                            </div>
                        `;
                    }
                    if (msg.text) {
                        const isEdited = msg.edited ? ' <span style="font-size: 10px; opacity: 0.7;">(изменено)</span>' : '';
                        messageContent += `<div class="message-text" data-msg-id="${msg.id}">${msg.text}${isEdited}</div>`;
                    }
                    
                    // Кнопки действий (только для своих сообщений и не системных)
                    let actionButtons = '';
                    if (msg.sender === 'client' && !msg.isSystem) {
                        actionButtons = `
                            <div class="message-actions" style="display: none; gap: 4px; margin-top: 4px;">
                                <button class="photo-action-btn" onclick="editMessage(${msg.id}, '${currentChatId}')" title="Редактировать">✏️</button>
                                <button class="photo-action-btn" onclick="deleteMessage(${msg.id}, '${currentChatId}')" title="Удалить">🗑️</button>
                            </div>
                        `;
                    }
                    
                    messageDiv.innerHTML = `
                        ${messageContent}
                        <div class="message-time">${time}${actionButtons}</div>
                    `;
                    
                    // Показываем кнопки при наведении
                    messageDiv.addEventListener('mouseenter', function() {
                        const actions = this.querySelector('.message-actions');
                        if (actions) actions.style.display = 'flex';
                    });
                    messageDiv.addEventListener('mouseleave', function() {
                        const actions = this.querySelector('.message-actions');
                        if (actions) actions.style.display = 'none';
                    });
                    
                    groupDiv.appendChild(messageDiv);
                });
                
                container.appendChild(groupDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // Отправка сообщения клиентом
        function sendMessage() {
            // Проверяем есть ли одобренная запись
            const clientId = getClientId();
            if (!checkClientHasApprovedOrder(clientId)) {
                showNotification('Чат будет доступен после одобрения записи мастером', 'error');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                showNotification('Введите сообщение', 'error');
                return;
            }
            
            if (!currentChatId) {
                currentChatId = clientId;
                if (!chats[currentChatId]) {
                    createNewChat(currentChatId);
                }
            }
            
            const newMessage = {
                id: Date.now(),
                text: message,
                sender: 'client',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Обновляем активность чата
            chats[currentChatId].info.lastActivity = new Date().toISOString();
            chats[currentChatId].info.unreadCount = (chats[currentChatId].info.unreadCount || 0) + 1;
            
            chats[currentChatId].messages.push(newMessage);
            manageChatStorage(currentChatId);
            saveChats();
            
            messageInput.value = '';
            renderChatMessages();
            showNotification('Сообщение отправлено!', 'success');
            
            // Если мастер онлайн, обновляем его интерфейс
            if (isMaster) {
                renderChatsList();
            }
        }
        
        // Отправка сообщения мастером
        function sendMasterMessage() {
            const messageInput = document.getElementById('masterMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatId) {
                showNotification('Введите сообщение', 'error');
                return;
            }
            
            const newMessage = {
                id: Date.now(),
                text: message,
                sender: 'master',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Обновляем активность чата
            chats[currentChatId].info.lastActivity = new Date().toISOString();
            
            chats[currentChatId].messages.push(newMessage);
            manageChatStorage(currentChatId);
            saveChats();
            
            messageInput.value = '';
            renderMasterChatMessages();
            showNotification('Сообщение отправлено!', 'success');
        }
        
        // Обработка фото для клиента
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                showLoading('Обрабатываем фото...');
                
                const processImage = CHAT_CONFIG.COMPRESS_IMAGES ? 
                    compressImage(file, CHAT_CONFIG.MAX_IMAGE_WIDTH, CHAT_CONFIG.IMAGE_QUALITY) :
                    new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                
                processImage
                    .then(photoData => {
                        sendPhotoMessage(photoData);
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Ошибка обработки фото:', error);
                        showNotification('Ошибка при обработке фото', 'error');
                        hideLoading();
                    });
            }
            e.target.value = '';
        }
        
        // Обработка фото для мастера
        function handleMasterPhotoUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                showLoading('Обрабатываем фото...');
                
                const processImage = CHAT_CONFIG.COMPRESS_IMAGES ? 
                    compressImage(file, CHAT_CONFIG.MAX_IMAGE_WIDTH, CHAT_CONFIG.IMAGE_QUALITY) :
                    new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                
                processImage
                    .then(photoData => {
                        sendMasterPhotoMessage(photoData);
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Ошибка обработки фото:', error);
                        showNotification('Ошибка при обработке фото', 'error');
                        hideLoading();
                    });
            }
            e.target.value = '';
        }
        
        // Отправка фото клиентом
        function sendPhotoMessage(photoData) {
            // Проверяем есть ли одобренная запись
            const clientId = getClientId();
            if (!checkClientHasApprovedOrder(clientId)) {
                showNotification('Чат будет доступен после одобрения записи мастером', 'error');
                return;
            }
            
            if (!currentChatId) {
                currentChatId = clientId;
                if (!chats[currentChatId]) {
                    createNewChat(currentChatId);
                }
            }
            
            const newMessage = {
                id: Date.now(),
                text: '',
                photo: photoData,
                sender: 'client',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Обновляем активность чата
            chats[currentChatId].info.lastActivity = new Date().toISOString();
            chats[currentChatId].info.unreadCount = (chats[currentChatId].info.unreadCount || 0) + 1;
            
            chats[currentChatId].messages.push(newMessage);
            manageChatStorage(currentChatId);
            saveChats();
            
            renderChatMessages();
            showNotification('Фото отправлено!', 'success');
            
            // Если мастер онлайн, обновляем его интерфейс
            if (isMaster) {
                renderChatsList();
            }
        }
        
        // Отправка фото мастером
        function sendMasterPhotoMessage(photoData) {
            if (!currentChatId) return;
            
            const newMessage = {
                id: Date.now(),
                text: '',
                photo: photoData,
                sender: 'master',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Обновляем активность чата
            chats[currentChatId].info.lastActivity = new Date().toISOString();
            
            chats[currentChatId].messages.push(newMessage);
            manageChatStorage(currentChatId);
            saveChats();
            
            renderMasterChatMessages();
            showNotification('Фото отправлено!', 'success');
        }
        
        // Сохранение чатов
        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }
        
        // Управление хранилищем для конкретного чата
        function manageChatStorage(chatId) {
            if (!chats[chatId]) return;
            
            const now = new Date();
            const cutoffDate = new Date(now);
            cutoffDate.setDate(cutoffDate.getDate() - CHAT_CONFIG.MAX_DAYS);
            
            // Фильтруем по дате
            chats[chatId].messages = chats[chatId].messages.filter(msg => 
                new Date(msg.timestamp) > cutoffDate
            );
            
            // Ограничение по общему количеству сообщений
            if (chats[chatId].messages.length > CHAT_CONFIG.MAX_MESSAGES) {
                chats[chatId].messages = chats[chatId].messages.slice(-CHAT_CONFIG.MAX_MESSAGES);
            }
            
            // Ограничение по количеству фото
            const photoMessages = chats[chatId].messages.filter(msg => msg.photo);
            if (photoMessages.length > CHAT_CONFIG.MAX_PHOTOS) {
                const photosToRemove = photoMessages.slice(0, photoMessages.length - CHAT_CONFIG.MAX_PHOTOS);
                const idsToRemove = photosToRemove.map(msg => msg.id);
                chats[chatId].messages = chats[chatId].messages.filter(msg => 
                    !idsToRemove.includes(msg.id)
                );
            }
            
            enforceStorageLimit();
        }

        // Вспомогательные функции для чата
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'вчера';
            } else if (diffDays < 7) {
                return `${diffDays} д.`;
            } else {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            }
        }
        
        function getLastSeen(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffMinutes < 5) {
                return 'Online';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} мин назад`;
            } else if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                return `${hours} ч назад`;
            } else {
                const days = Math.floor(diffMinutes / 1440);
                return `${days} д назад`;
            }
        }

        // ========== СИСТЕМА ЛОЯЛЬНОСТИ И РЕЙТИНГА ==========
        let loyaltySystem = JSON.parse(localStorage.getItem('loyaltySystem')) || {
            clients: {},
            settings: {
                levels: [
                    { name: "Начинающий", discount: 0, visitsRequired: 3, cycles: 1 },
                    { name: "Знаток в маникюре", discount: 5, visitsRequired: 6, cycles: 2 },
                    { name: "Фанатка nailsq", discount: 10, visitsRequired: 9, cycles: 3 },
                    { name: "Элита nailsq", discount: 15, visitsRequired: 0, cycles: 0 }
                ]
            }
        };

        // Получение данных клиента
        function getClientData() {
            const clientId = getClientId();
            if (!loyaltySystem.clients[clientId]) {
                loyaltySystem.clients[clientId] = {
                    totalVisits: 0,
                    currentLevel: 0,
                    visitsInCurrentLevel: 0,
                    cyclesCompleted: 0,
                    nextVisitHasDiscount: false,
                    lastVisitDate: null
                };
                saveLoyaltySystem();
            }
            return loyaltySystem.clients[clientId];
        }

        // Обновление данных клиента после заказа
        function updateClientAfterOrder() {
            const clientData = getClientData();
            const clientId = getClientId();
            
            clientData.totalVisits++;
            clientData.visitsInCurrentLevel++;
            clientData.lastVisitDate = new Date().toISOString();
            
            const currentLevel = loyaltySystem.settings.levels[clientData.currentLevel];
            
            // Проверка на скидку
            clientData.nextVisitHasDiscount = false;
            
            if (clientData.currentLevel === 0) {
                // Уровень 0: Начинающий - нет скидок
                if (clientData.visitsInCurrentLevel >= currentLevel.visitsRequired) {
                    levelUpClient(clientId);
                }
            } else {
                // Проверяем, является ли это визитом со скидкой
                if (clientData.visitsInCurrentLevel === 1 || clientData.visitsInCurrentLevel % 3 === 0) {
                    clientData.nextVisitHasDiscount = true;
                }
                
                // Проверка перехода на следующий уровень
                if (currentLevel.cyclesCompleted !== undefined) {
                    const discountVisits = Math.floor((clientData.visitsInCurrentLevel - 1) / 3) + 1;
                    if (discountVisits > clientData.cyclesCompleted) {
                        clientData.cyclesCompleted = discountVisits;
                    }
                    
                    if (clientData.cyclesCompleted >= currentLevel.cycles && clientData.currentLevel < 3) {
                        levelUpClient(clientId);
                    }
                }
            }
            
            saveLoyaltySystem();
            updateLoyaltyDisplay();
        }

        // Повышение уровня клиента
        function levelUpClient(clientId) {
            const clientData = loyaltySystem.clients[clientId];
            if (clientData.currentLevel < 3) {
                clientData.currentLevel++;
                clientData.visitsInCurrentLevel = 0;
                clientData.cyclesCompleted = 0;
                clientData.nextVisitHasDiscount = true; // Первый визит на новом уровне со скидкой
                
                showNotification(`🎉 Поздравляем! Вы достигли уровня: ${loyaltySystem.settings.levels[clientData.currentLevel].name}`, 'success');
            }
            saveLoyaltySystem();
        }

        // Получение текущей скидки клиента
        function getClientDiscount() {
            const clientData = getClientData();
            const level = loyaltySystem.settings.levels[clientData.currentLevel];
            
            if (clientData.nextVisitHasDiscount) {
                return level.discount;
            }
            return 0;
        }

        // Получение информации об уровне клиента
        function getClientLevelInfo() {
            const clientData = getClientData();
            const level = loyaltySystem.settings.levels[clientData.currentLevel];
            const nextLevel = clientData.currentLevel < 3 ? loyaltySystem.settings.levels[clientData.currentLevel + 1] : null;
            
            return {
                currentLevel: level,
                nextLevel: nextLevel,
                visitsInCurrentLevel: clientData.visitsInCurrentLevel,
                totalVisits: clientData.totalVisits,
                nextVisitHasDiscount: clientData.nextVisitHasDiscount,
                progress: nextLevel ? Math.min(100, (clientData.visitsInCurrentLevel / nextLevel.visitsRequired) * 100) : 100
            };
        }

        // Сохранение системы лояльности
        function saveLoyaltySystem() {
            localStorage.setItem('loyaltySystem', JSON.stringify(loyaltySystem));
        }

        // Обновление отображения системы лояльности
        function updateLoyaltyDisplay() {
            const levelInfo = getClientLevelInfo();
            
            // Обновляем иконку уровня
            document.getElementById('currentLevelIcon').className = `level-icon level-${levelInfo.currentLevel ? levelInfo.currentLevel.discount/5 : 0}`;
            document.getElementById('currentLevelIcon').textContent = levelInfo.currentLevel ? (loyaltySystem.settings.levels.indexOf(levelInfo.currentLevel) + 1) : 1;
            
            // Обновляем название уровня
            document.getElementById('currentLevelName').textContent = levelInfo.currentLevel.name;
            
            // Обновляем описание
            if (levelInfo.nextLevel) {
                document.getElementById('nextLevelName').textContent = levelInfo.nextLevel.name;
                document.getElementById('visitsToNext').textContent = levelInfo.nextLevel.visitsRequired - levelInfo.visitsInCurrentLevel;
            } else {
                document.getElementById('nextLevelName').textContent = "максимальный";
                document.getElementById('visitsToNext').textContent = "0";
            }
            
            // Обновляем прогресс
            document.getElementById('levelProgress').className = `progress-bar progress-${levelInfo.currentLevel ? loyaltySystem.settings.levels.indexOf(levelInfo.currentLevel) : 0}`;
            document.getElementById('levelProgress').style.width = `${levelInfo.progress}%`;
            
            // Обновляем количество визитов
            document.getElementById('totalVisits').textContent = levelInfo.totalVisits;
            
            // Обновляем скидку
            const discount = getClientDiscount();
            document.getElementById('currentDiscount').textContent = `${discount}%`;
            
            // Обновляем описание скидки
            if (discount > 0) {
                document.getElementById('discountDescription').textContent = `Следующая скидка ${discount}% будет применена автоматически`;
            } else {
                document.getElementById('discountDescription').textContent = "Следующая скидка активируется автоматически";
            }
        }

        // Применение скидки к цене
        function applyDiscount(price) {
            const discount = getClientDiscount();
            if (discount > 0) {
                const discountedPrice = price * (1 - discount / 100);
                return {
                    original: price,
                    discounted: Math.round(discountedPrice),
                    discount: discount
                };
            }
            return {
                original: price,
                discounted: price,
                discount: 0
            };
        }

        // Обновление отображения цен с учетом скидки
        function updatePricesWithDiscount() {
            // Обновляем цены в популярных услугах
            document.querySelectorAll('.hit-card').forEach(card => {
                const priceElement = card.querySelector('.hit-price');
                const price = parseInt(priceElement.textContent);
                const discounted = applyDiscount(price);
                
                if (discounted.discount > 0) {
                    priceElement.innerHTML = `
                        <span class="original-price">${discounted.original} ₽</span>
                        <span class="discounted-price">${discounted.discounted} ₽</span>
                    `;
                }
            });
            
            // Обновляем цены в услугах по категориям
            document.querySelectorAll('.service-card').forEach(card => {
                const priceElement = card.querySelector('.price');
                const price = parseInt(priceElement.textContent);
                const discounted = applyDiscount(price);
                
                if (discounted.discount > 0) {
                    priceElement.innerHTML = `
                        <span class="original-price">${discounted.original} ₽</span>
                        <span class="discounted-price">${discounted.discounted} ₽</span>
                    `;
                }
            });
        }

        // ========== ОСНОВНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ ==========

        // Переключение режима мастера/клиента
        function toggleMasterMode() {
            // Проверка доступа перед переключением
            if (!checkMasterAccess()) {
                showNotification('Доступ запрещен. Только мастер может использовать этот режим.', 'error');
                // Сбрасываем режим мастера если он был включен
                isMaster = false;
                localStorage.setItem('isMaster', 'false');
                updateUIForUserRole();
                return;
            }
            
            isMaster = !isMaster;
            localStorage.setItem('isMaster', isMaster);
            
            const toggleBtn = document.getElementById('modeToggle');
            if (isMaster) {
                toggleBtn.textContent = 'Режим мастера ВКЛ';
                toggleBtn.style.background = '#00a86b';
                showNotification('Режим мастера включен!', 'success');
            } else {
                toggleBtn.textContent = 'Режим мастера';
                toggleBtn.style.background = '#0078D4';
                showNotification('Режим мастера выключен', 'info');
            }
            
            updateUIForUserRole();
            // Обновляем интерфейс чатов
            initChatSystem();
        }

        // Обновление интерфейса по роли
        function updateUIForUserRole() {
            const adminTab = document.getElementById('adminTab');
            const userRole = document.getElementById('userRole');
            const favoritesTab = document.querySelector('.profile-tab[data-profile-tab="favorites"]');
            const loyaltyTab = document.querySelector('.profile-tab[data-profile-tab="loyalty"]');
            const modeToggleBtn = document.getElementById('modeToggle');
            
            // Проверяем доступ перед показом режима мастера
            const hasMasterAccess = checkMasterAccess();
            
            // Скрываем кнопку переключения режима если нет доступа
            if (modeToggleBtn) {
                if (!hasMasterAccess) {
                    modeToggleBtn.style.display = 'none';
                } else {
                    modeToggleBtn.style.display = 'block';
                }
            }
            
            // Если режим мастера включен, но нет доступа - отключаем
            if (isMaster && !hasMasterAccess) {
                isMaster = false;
                localStorage.setItem('isMaster', 'false');
                showNotification('Доступ запрещен. Только мастер может использовать этот режим.', 'error');
            }
            
            if (isMaster && hasMasterAccess) {
                if (adminTab) adminTab.style.display = 'block';
                if (userRole) userRole.textContent = 'Мастер';
                // Скрываем вкладки избранного и лояльности для мастера
                if (favoritesTab) favoritesTab.style.display = 'none';
                if (loyaltyTab) loyaltyTab.style.display = 'none';
            } else {
                if (adminTab) adminTab.style.display = 'none';
                if (userRole) {
                    // Показываем уровень лояльности вместо "Клиент"
                    const clientLevel = getClientLoyaltyLevel();
                    const levelNames = ['Начинающий', 'Знаток в маникюре', 'Фанатка nailsq', 'Элита nailsq'];
                    userRole.textContent = levelNames[clientLevel] || 'Клиент';
                }
                // Показываем вкладки избранного и лояльности для клиента
                if (favoritesTab) favoritesTab.style.display = 'block';
                if (loyaltyTab) loyaltyTab.style.display = 'block';
                
                // Обновляем отображение системы лояльности для клиента
                updateLoyaltyDisplay();
                updatePricesWithDiscount();
            }
        }

        // Заполняем профиль данными из Telegram
        if (user) {
            const userName = user.first_name || 'Клиент';
            const userUsername = user.username ? `@${user.username}` : 'Ваш профиль';
            
            // Обновляем данные в профиле
            const userInfoElement = document.querySelector('.user-info');
            if (userInfoElement) {
                const nameElement = userInfoElement.querySelector('h2');
                const usernameElement = userInfoElement.querySelector('p');
                
                if (nameElement) nameElement.textContent = userName;
                if (usernameElement) usernameElement.textContent = userUsername;
            }
        }

        // ========== TELEGRAM MAIN BUTTON ==========
        function updateTelegramButton() {
            if (cart.length > 0) {
                tg.MainButton.setText(`Корзина (${cart.length}) - ${getTotalAmount()} ₽`);
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }
        
        // Настройка кнопки
        tg.MainButton.setParams({
            text: 'Корзина',
            color: '#0078D4',
            text_color: '#FFFFFF'
        });
        
        // Обработчик нажатия на кнопку
        tg.MainButton.onClick(function() {
            document.getElementById('cartModal').classList.add('active');
            updateCartModal();
        });

        // Переключение вкладок
        function switchToTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
                if (nav.getAttribute('data-tab') === tabName) {
                    nav.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            // Специальные действия для некоторых вкладок
            if (tabName === 'profile') {
                setTimeout(() => {
                    if (document.getElementById('adminContent').style.display !== 'none') {
                        updateAdminSchedule();
                        updateSchedulePreview(); // Обновляем предпросмотр графика
                        updateChatStats(); // Обновляем статистику чата
                    }
                }, 100);
            } else if (tabName === 'chat') {
                // Обновляем чат при переключении на вкладку
                initChatSystem();
            }
        }

        // ========== СИСТЕМА ИЗБРАННОГО ==========
        function findServiceById(serviceId) {
            for (const category in servicesData) {
                const service = servicesData[category].find(s => s.id === serviceId);
                if (service) return service;
            }
            return null;
        }

        function getClientId() {
            if (user && user.id) {
                return String(user.id);
            }
            const storedId = localStorage.getItem('clientId');
            if (storedId) {
                const match = storedId.match(/client_(\d+)/);
                return match ? match[1] : storedId.replace('client_', '');
            }
            return null;
        }

        function toggleFavorite(serviceId) {
            const service = findServiceById(serviceId);
            if (!service) return;

            const index = favorites.findIndex(fav => fav.id === serviceId);
            
            if (index === -1) {
                // Добавляем в избранное
                favorites.push(service);
                showNotification('Услуга добавлена в избранное!', 'success');
            } else {
                // Удаляем из избранного
                favorites.splice(index, 1);
                showNotification('Услуга удалена из избранного', 'info');
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesDisplay();
            updateServicesDisplay();
        }

        function isFavorite(serviceId) {
            return favorites.some(fav => fav.id === serviceId);
        }

        function updateFavoritesDisplay() {
            const favoritesContent = document.getElementById('favoritesContent');
            if (!favoritesContent) return;

            if (favorites.length === 0) {
                favoritesContent.innerHTML = `
                    <div class="empty-state">
                        <p>У вас пока нет избранных услуг</p>
                        <button class="browse-services" onclick="switchToTab('services')">Найти услуги</button>
                    </div>
                `;
            } else {
                let html = '<div class="favorites-grid">';
                
                favorites.forEach(service => {
                    html += `
                        <div class="favorite-service-card">
                            <div class="favorite-service-emoji">${service.emoji}</div>
                            <div class="favorite-service-info">
                                <div class="favorite-service-name">${service.name}</div>
                                <div class="favorite-service-price">${service.price} ₽</div>
                            </div>
                            <button class="remove-favorite" onclick="toggleFavorite(${service.id})">
                                Удалить
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                favoritesContent.innerHTML = html;
            }
        }

        function removeFromFavorites(serviceId) {
            favorites = favorites.filter(fav => fav.id !== serviceId);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesDisplay();
            updateServicesDisplay();
            showNotification('Услуга удалена из избранного', 'info');
        }

        // ========== ЗАГРУЗКА УСЛУГ ==========
        function loadServices() {
            loadPopularServices();
            loadServicesByCategory();
        }

        function loadPopularServices() {
            const container = document.getElementById('popularServices');
            if (!container) return;

            // Берем первые 3 услуги из каждой категории для популярных
            let popularServices = [];
            Object.values(servicesData).forEach(category => {
                popularServices = popularServices.concat(category.slice(0, 2));
            });

            let html = '';
            popularServices.forEach(service => {
                const isFav = isFavorite(service.id);
                const discountedPrice = applyDiscount(service.price);
                
                let priceHTML = '';
                if (discountedPrice.discount > 0) {
                    priceHTML = `
                        <span class="original-price">${discountedPrice.original} ₽</span>
                        <span class="discounted-price">${discountedPrice.discounted} ₽</span>
                    `;
                } else {
                    priceHTML = `${service.price} ₽`;
                }
                
                html += `
                    <div class="hit-card">
                        <button class="favorite-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite(${service.id})">
                            <span class="heart-icon">${isFav ? '★' : '☆'}</span>
                        </button>
                        <div class="hit-image">${service.emoji}</div>
                        <div class="hit-info">
                            <h3>${service.name}</h3>
                            <p class="hit-description">${service.description}</p>
                            <div class="hit-footer">
                                <span class="hit-price">${priceHTML}</span>
                                <button class="book-btn" 
                                        data-service="${service.name}" 
                                        data-price="${service.price}" 
                                        data-duration="${service.duration}">
                                    Выбрать время
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadServicesByCategory() {
            const categories = ['manicure', 'extension', 'correction'];
            
            categories.forEach(category => {
                const container = document.getElementById(`${category}-services`);
                if (!container) return;
                
                let html = '';
                servicesData[category].forEach(service => {
                    const isFav = isFavorite(service.id);
                    const discountedPrice = applyDiscount(service.price);
                    
                    let priceHTML = '';
                    if (discountedPrice.discount > 0) {
                        priceHTML = `
                            <span class="original-price">${discountedPrice.original} ₽</span>
                            <span class="discounted-price">${discountedPrice.discounted} ₽</span>
                        `;
                    } else {
                        priceHTML = `${service.price} ₽`;
                    }
                    
                    html += `
                        <div class="service-card">
                            <button class="favorite-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite(${service.id})">
                                <span class="heart-icon">${isFav ? '❤️' : '🤍'}</span>
                            </button>
                            <div class="service-image">${service.emoji}</div>
                            <div class="service-details">
                                <h3>${service.name}</h3>
                                <p class="service-description">${service.description}</p>
                                <div class="service-footer">
                                    <span class="price">${priceHTML}</span>
                                    <button class="book-btn" 
                                            data-service="${service.name}" 
                                            data-price="${service.price}" 
                                            data-duration="${service.duration}">
                                        Выбрать время
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            });
        }

        function updateServicesDisplay() {
            loadPopularServices();
            loadServicesByCategory();
        }

        // ========== СИСТЕМА БРОНИРОВАНИЯ (ОБНОВЛЕНА ДО 1 МЕСЯЦА) ==========
        function generateDates() {
            const dates = [];
            const today = new Date();
            const minBookingDate = new Date(today.getTime() + 24 * 60 * 60 * 1000); // Минимум 24 часа вперед
            
            // Генерируем 30 дней, начиная с минимальной даты бронирования
            let daysToAdd = 1;
            let datesGenerated = 0;
            
            while (datesGenerated < 30 && daysToAdd <= 60) {
                const date = new Date(today);
                date.setDate(today.getDate() + daysToAdd);
                daysToAdd++;
                
                // Пропускаем даты, которые меньше чем через 24 часа
                if (date < minBookingDate) {
                    continue;
                }
                
                // Проверяем график работы
                const dayOfWeek = date.getDay();
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const daySchedule = workSchedule[dayNames[dayOfWeek]];
                
                if (daySchedule && daySchedule.enabled) {
                    dates.push({
                        date: date.toISOString().split('T')[0],
                        readable: date.toLocaleDateString('ru-RU', { 
                            weekday: 'short', 
                            day: 'numeric', 
                            month: 'short' 
                        })
                    });
                    datesGenerated++;
                }
            }
            return dates;
        }

        function generateTimeSlots(date, duration) {
            const slots = [];
            const dayOfWeek = new Date(date).getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const daySchedule = workSchedule[dayNames[dayOfWeek]];
            
            if (!daySchedule || !daySchedule.enabled) {
                return slots;
            }

            const [startHour, startMinute] = daySchedule.start.split(':').map(Number);
            const [endHour, endMinute] = daySchedule.end.split(':').map(Number);
            
            const startTime = startHour * 60 + startMinute;
            const endTime = endHour * 60 + endMinute;
            
            for (let time = startTime; time < endTime; time += 30) {
                const hour = Math.floor(time / 60);
                const minute = time % 60;
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const isAvailable = isTimeAvailable(date, timeString, duration);
                
                slots.push({
                    time: timeString,
                    available: isAvailable
                });
            }
            return slots;
        }

        function isTimeAvailable(date, time, duration) {
            const startTime = new Date(`${date}T${time}`);
            const endTime = new Date(startTime.getTime() + duration * 60000);
            const now = new Date();
            
            // ОГРАНИЧЕНИЕ: Нельзя записаться менее чем за 24 часа
            const minBookingTime = new Date(now.getTime() + 24 * 60 * 60 * 1000); // 24 часа от текущего момента
            if (startTime < minBookingTime) {
                return false;
            }
            
            // Проверяем график работы
            const dayOfWeek = new Date(date).getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const daySchedule = workSchedule[dayNames[dayOfWeek]];
            
            if (!daySchedule || !daySchedule.enabled) {
                return false;
            }
            
            const scheduleStart = new Date(`${date}T${daySchedule.start}`);
            const scheduleEnd = new Date(`${date}T${daySchedule.end}`);
            
            // Проверяем что время записи не выходит за рамки рабочего дня
            if (startTime < scheduleStart || endTime > scheduleEnd) {
                return false;
            }
            
            // Получаем все записи на эту дату
            const dayBookings = bookedSlots.filter(b => b.date === date)
                .map(b => ({
                    start: new Date(`${b.date}T${b.startTime}`),
                    end: new Date(new Date(`${b.date}T${b.startTime}`).getTime() + b.duration * 60000)
                }))
                .sort((a, b) => a.start - b.start);
            
            // Проверяем пересечения с другими записями
            for (const booking of dayBookings) {
                if (startTime < booking.end && endTime > booking.start) {
                    return false;
                }
            }
            
            // Проверяем свободные слоты времени
            const freeSlots = freeTimeSlots.filter(slot => slot.date === date && slot.enabled);
            
            // Если есть свободные слоты, проверяем попадает ли время в них
            if (freeSlots.length > 0) {
                let fitsInFreeSlot = false;
                for (const slot of freeSlots) {
                    const slotStart = new Date(`${date}T${slot.startTime}`);
                    const slotEnd = new Date(`${date}T${slot.endTime}`);
                    
                    // Проверяем попадает ли наше время в свободный слот
                    if (startTime >= slotStart && endTime <= slotEnd) {
                        // Проверяем достаточно ли времени в слоте
                        const slotDuration = (slotEnd - slotStart) / 60000;
                        if (duration <= slotDuration) {
                            fitsInFreeSlot = true;
                            break;
                        }
                    }
                }
                
                // Если время не попадает в свободные слоты, проверяем обычную логику
                if (!fitsInFreeSlot) {
                    // КРИТИЧНО: Проверяем наличие непрерывного интервала достаточной длины
                    let availableUntil = scheduleEnd;
                    
                    // Находим следующую запись после нашего времени
                    for (const booking of dayBookings) {
                        if (booking.start > startTime) {
                            availableUntil = booking.start;
                            break;
                        }
                    }
                    
                    // Вычисляем доступное непрерывное время в минутах
                    const availableDuration = (availableUntil - startTime) / 60000;
                    
                    // Если услуга не помещается в доступное непрерывное время, возвращаем false
                    if (duration > availableDuration) {
                        return false;
                    }
                }
            } else {
                // Нет свободных слотов, проверяем обычную логику
                // КРИТИЧНО: проверяем, что есть достаточно непрерывного свободного времени
                let availableUntil = scheduleEnd;
                
                // Находим следующую запись после нашего времени
                for (const booking of dayBookings) {
                    if (booking.start > startTime) {
                        availableUntil = booking.start;
                        break;
                    }
                }
                
                // Вычисляем доступное непрерывное время в минутах
                const availableDuration = (availableUntil - startTime) / 60000;
                
                // Если услуга не помещается в доступное непрерывное время, возвращаем false
                if (duration > availableDuration) {
                    return false;
                }
            }
            
            return true;
        }

        // Функция для поиска альтернативных дат и времени для длинной услуги
        function findAlternativeSlots(serviceDuration, maxDays = 30) {
            const alternatives = [];
            const today = new Date();
            
            for (let i = 1; i <= maxDays; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() + i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                // Проверяем график работы
                const dayOfWeek = checkDate.getDay();
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const daySchedule = workSchedule[dayNames[dayOfWeek]];
                
                if (!daySchedule || !daySchedule.enabled) {
                    continue;
                }
                
                const [startHour, startMinute] = daySchedule.start.split(':').map(Number);
                const [endHour, endMinute] = daySchedule.end.split(':').map(Number);
                const startTime = startHour * 60 + startMinute;
                const endTime = endHour * 60 + endMinute;
                
                // Ищем доступные временные слоты на этот день
                for (let time = startTime; time < endTime; time += 30) {
                    const hour = Math.floor(time / 60);
                    const minute = time % 60;
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    if (isTimeAvailable(dateStr, timeString, serviceDuration)) {
                        alternatives.push({
                            date: dateStr,
                            time: timeString,
                            readable: checkDate.toLocaleDateString('ru-RU', { 
                                weekday: 'short', 
                                day: 'numeric', 
                                month: 'short' 
                            })
                        });
                        
                        // Ограничиваем количество альтернатив
                        if (alternatives.length >= 5) {
                            return alternatives;
                        }
                    }
                }
            }
            
            return alternatives;
        }

        // Функция для поиска услуг, которые помещаются в доступное время
        function findFittingServices(date, time, maxDuration) {
            const fittingServices = [];
            
            // Проходим по всем услугам
            for (const category in servicesData) {
                servicesData[category].forEach(service => {
                    if (service.duration <= maxDuration && service.duration > 0) {
                        if (isTimeAvailable(date, time, service.duration)) {
                            fittingServices.push(service);
                        }
                    }
                });
            }
            
            // Сортируем по длительности (от большей к меньшей)
            fittingServices.sort((a, b) => b.duration - a.duration);
            
            return fittingServices.slice(0, 5); // Возвращаем до 5 услуг
        }

        function saveBookedSlots() {
            localStorage.setItem('bookedSlots', JSON.stringify(bookedSlots));
        }

        function bookTimeSlot(date, time, duration) {
            const bookingId = Date.now();
            bookedSlots.push({
                date: date,
                startTime: time,
                duration: duration,
                id: bookingId
            });
            saveBookedSlots();
            return bookingId;
        }

        function unbookTimeSlot(bookingId) {
            bookedSlots = bookedSlots.filter(booking => booking.id !== bookingId);
            saveBookedSlots();
        }

        // ========== КОРЗИНА ==========
        function addToCart(service, price, date, time, duration) {
            const bookingId = bookTimeSlot(date, time, duration);
            
            cart.push({
                service: service,
                price: price,
                date: date,
                time: time,
                duration: duration,
                bookingId: bookingId,
                id: Date.now()
            });
            
            updateCartDisplay();
            
            // Анимация кнопки
            const buttons = document.querySelectorAll(`.book-btn[data-service="${service}"]`);
            buttons.forEach(button => {
                const originalText = button.textContent;
                button.textContent = '✓ Добавлено';
                button.classList.add('added');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('added');
                }, 2000);
            });
        }

        function removeFromCart(itemId) {
            const item = cart.find(item => item.id === itemId);
            if (item) {
                unbookTimeSlot(item.bookingId);
            }
            
            cart = cart.filter(item => item.id !== itemId);
            updateCartDisplay();
            updateCartModal();
        }

        function updateCartDisplay() {
            // Обновляем Telegram кнопку
            updateTelegramButton();
        }

        function updateCartModal() {
            const cartItems = document.getElementById('cartItems');
            const modalTotal = document.getElementById('modalTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart"><p>Корзина пуста</p></div>';
                checkoutBtn.disabled = true;
            } else {
                let itemsHTML = '';
                cart.forEach(item => {
                    const readableDate = new Date(item.date).toLocaleDateString('ru-RU');
                    const durationHours = Math.floor(item.duration / 60);
                    const durationMinutes = item.duration % 60;
                    const durationText = `${durationHours}ч ${durationMinutes > 0 ? durationMinutes + 'м' : ''}`;
                    
                    itemsHTML += `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.service}</div>
                                <div class="cart-item-details">${readableDate} в ${item.time} (${durationText})</div>
                                <div class="cart-item-price">${item.price} ₽</div>
                            </div>
                            <button class="remove-from-cart" onclick="removeFromCart(${item.id})">Удалить</button>
                        </div>
                    `;
                });
                cartItems.innerHTML = itemsHTML;
                checkoutBtn.disabled = false;
            }
            
            modalTotal.textContent = `${getTotalAmount()} ₽`;
        }

        function getTotalAmount() {
            return cart.reduce((total, item) => total + item.price, 0);
        }

        // ========== ОФОРМЛЕНИЕ ЗАКАЗА ==========
        function checkout() {
            if (cart.length === 0) {
                showNotification('Корзина пуста', 'error');
                return;
            }

            // Показываем предупреждение о предоплате
            if (!confirm('ВАЖНО: Предоплата возвращается только по важным причинам и не менее чем за три дня до записи. Предоплата включена в стоимость услуги.\n\nПродолжить оформление?')) {
                return;
            }

            showLoading('Оформление заказа...');

            setTimeout(() => {
                try {
                    clientWishes = document.getElementById('clientWishes').value;
                    
                    // Получаем правильный ID клиента
                    const clientId = user?.id || (() => {
                        const storedId = localStorage.getItem('clientId');
                        if (storedId) {
                            // Извлекаем числовой ID из строки 'client_123'
                            const match = storedId.match(/client_(\d+)/);
                            return match ? match[1] : storedId.replace('client_', '');
                        }
                        return null;
                    })();
                    
                    const order = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        services: [...cart],
                        wishes: clientWishes,
                        photo: referencePhoto,
                        total: getTotalAmount(),
                        status: 'pending',
                        approved: false,
                        client: {
                            name: user?.first_name || "Клиент",
                            username: user?.username ? `@${user.username}` : "@клиент",
                            userId: clientId || 'user-' + Date.now()
                        }
                    };

                    // Сохраняем заказ
                    const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
                    orders.push(order);
                    localStorage.setItem('masterOrders', JSON.stringify(orders));
                    
                    // Обновляем статистику заработка
                    updateEarningsStats(order);
                    
                    // Обновляем систему лояльности
                    updateClientAfterOrder();
                    
                    // Обновляем список заказов клиента
                    updateClientAppointments();

                    showNotification(`Заказ принят! Номер заказа: #${order.id}`, 'success');
                    resetOrderForm();
                    hideLoading();

                } catch (error) {
                    hideLoading();
                    showNotification('Ошибка при оформлении заказа', 'error');
                    console.error('Checkout error:', error);
                }
            }, 2000);
        }

        function resetOrderForm() {
            clientWishes = '';
            referencePhoto = null;
            document.getElementById('clientWishes').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoReference').value = '';
            
            cart = [];
            updateCartDisplay();
            updateCartModal();
            closeCartModal();
        }

        // ========== ЗАКАЗЫ КЛИЕНТА ==========
        function getClientOrders() {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            
            // Получаем ID клиента
            let clientId = user?.id;
            if (!clientId) {
                const storedId = localStorage.getItem('clientId');
                if (storedId) {
                    // Извлекаем числовой ID из строки 'client_123' или 'client_123_abc'
                    const match = storedId.match(/client_(\d+)/);
                    clientId = match ? match[1] : storedId.replace(/^client_/, '');
                }
            }
            
            if (!clientId) {
                // Если нет ID, пытаемся найти по имени из Telegram
                const clientName = user?.first_name || "Клиент";
                return orders.filter(order => order.client.name === clientName);
            }
            
            // Фильтруем заказы по userId
            return orders.filter(order => {
                const orderUserId = order.client.userId;
                // Пропускаем временные ID
                if (typeof orderUserId === 'string' && orderUserId.startsWith('user-')) {
                    return false;
                }
                // Сравниваем ID
                return String(orderUserId) === String(clientId);
            });
        }

        // ========== СИСТЕМА ЛОЯЛЬНОСТИ ==========
        function getClientLoyaltyLevel() {
            const clientOrders = getClientOrders();
            const confirmedOrders = clientOrders.filter(order => order.approved === true || order.status === 'confirmed');
            const visitCount = confirmedOrders.length;
            
            if (visitCount >= 9) return 3; // Элита nailsq
            if (visitCount >= 6) return 2; // Фанатка nailsq
            if (visitCount >= 3) return 1; // Знаток в маникюре
            return 0; // Начинающий
        }

        function getClientLoyaltyLevelFromOrder(order) {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const clientOrders = orders.filter(o => String(o.client.userId) === String(order.client.userId));
            const confirmedOrders = clientOrders.filter(o => o.approved === true || o.status === 'confirmed');
            const visitCount = confirmedOrders.length;
            
            if (visitCount >= 9) return 3;
            if (visitCount >= 6) return 2;
            if (visitCount >= 3) return 1;
            return 0;
        }

        function getClientDiscount(level) {
            const discounts = [0, 5, 10, 15];
            return discounts[level] || 0;
        }

        function updateClientAfterOrder() {
            // Обновляем уровень лояльности после заказа
            updateLoyaltyDisplay();
            updateUIForUserRole();
        }

        function updateLoyaltyDisplay() {
            const level = getClientLoyaltyLevel();
            const levelNames = ['Начинающий', 'Знаток в маникюре', 'Фанатка nailsq', 'Элита nailsq'];
            const nextLevelNames = ['Знаток в маникюре', 'Фанатка nailsq', 'Элита nailsq', 'Элита nailsq'];
            const visitsNeeded = [3, 6, 9, 0];
            
            const clientOrders = getClientOrders();
            const confirmedOrders = clientOrders.filter(order => order.approved === true || order.status === 'confirmed');
            const visitCount = confirmedOrders.length;
            
            const currentLevelName = document.getElementById('currentLevelName');
            const nextLevelName = document.getElementById('nextLevelName');
            const currentLevelIcon = document.getElementById('currentLevelIcon');
            const levelProgress = document.getElementById('levelProgress');
            const totalVisits = document.getElementById('totalVisits');
            const visitsToNext = document.getElementById('visitsToNext');
            const currentDiscount = document.getElementById('currentDiscount');
            
            if (currentLevelName) currentLevelName.textContent = levelNames[level];
            if (nextLevelName) nextLevelName.textContent = nextLevelNames[level];
            if (currentLevelIcon) {
                currentLevelIcon.textContent = level + 1;
                currentLevelIcon.className = `level-icon level-${level}`;
            }
            if (totalVisits) totalVisits.textContent = visitCount;
            
            const discount = getClientDiscount(level);
            if (currentDiscount) currentDiscount.textContent = discount + '%';
            
            if (level < 3) {
                const visitsToNextLevel = visitsNeeded[level + 1] - visitCount;
                if (visitsToNext) visitsToNext.textContent = visitsToNextLevel > 0 ? visitsToNextLevel : 0;
                
                const progress = level < 3 ? ((visitCount - visitsNeeded[level]) / (visitsNeeded[level + 1] - visitsNeeded[level])) * 100 : 100;
                if (levelProgress) {
                    levelProgress.className = `progress-bar progress-${level}`;
                    levelProgress.style.width = Math.max(0, Math.min(100, progress)) + '%';
                }
            } else {
                if (visitsToNext) visitsToNext.textContent = '0';
                if (levelProgress) {
                    levelProgress.className = 'progress-bar progress-3';
                    levelProgress.style.width = '100%';
                }
            }
        }

        function applyDiscount(price) {
            if (isMaster) {
                return { original: price, discounted: price, discount: 0 };
            }
            const level = getClientLoyaltyLevel();
            const discount = getClientDiscount(level);
            if (discount > 0) {
                const discounted = Math.round(price * (1 - discount / 100));
                return { original: price, discounted: discounted, discount: discount };
            }
            return { original: price, discounted: price, discount: 0 };
        }

        function updatePricesWithDiscount() {
            // Обновляем цены с учетом скидок в интерфейсе
            updateServicesDisplay();
        }

        function updateClientAppointments() {
            const activeContainer = document.getElementById('activeAppointmentsContent');
            const historyContainer = document.getElementById('historyAppointmentsContent');
            if (!activeContainer || !historyContainer) return;
            
            const clientOrders = getClientOrders();
            const now = new Date();
            
            // Разделяем на активные и прошедшие записи
            const activeOrders = [];
            const historyOrders = [];
            
            clientOrders.forEach(order => {
                const firstService = order.services[0];
                if (firstService && firstService.date && firstService.time) {
                    const serviceDateTime = new Date(`${firstService.date}T${firstService.time}`);
                    if (serviceDateTime > now && order.status !== 'cancelled') {
                        activeOrders.push(order);
                    } else {
                        historyOrders.push(order);
                    }
                } else {
                    // Если нет даты/времени, считаем историей
                    historyOrders.push(order);
                }
            });
            
            // Сортируем активные: сначала подтвержденные, потом по дате
            activeOrders.sort((a, b) => {
                const aConfirmed = a.approved === true || a.status === 'confirmed';
                const bConfirmed = b.approved === true || b.status === 'confirmed';
                if (aConfirmed !== bConfirmed) {
                    return bConfirmed ? 1 : -1;
                }
                const dateA = a.services[0]?.date || a.date;
                const dateB = b.services[0]?.date || b.date;
                if (dateA !== dateB) {
                    return new Date(dateA) - new Date(dateB);
                }
                const timeA = a.services[0]?.time || '';
                const timeB = b.services[0]?.time || '';
                return timeA.localeCompare(timeB);
            });
            
            // Сортируем историю: новые сверху
            historyOrders.sort((a, b) => {
                const dateA = a.services[0]?.date || a.date;
                const dateB = b.services[0]?.date || b.date;
                if (dateA !== dateB) {
                    return new Date(dateB) - new Date(dateA);
                }
                const timeA = a.services[0]?.time || '';
                const timeB = b.services[0]?.time || '';
                return timeB.localeCompare(timeA);
            });
            
            // Рендерим активные записи
            if (activeOrders.length === 0) {
                activeContainer.innerHTML = `
                    <div class="empty-state">
                        <p>У вас пока нет активных записей</p>
                        <button class="browse-services" onclick="switchToTab('services')">Записаться на услугу</button>
                    </div>
                `;
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                activeOrders.forEach(order => {
                    html += renderAppointmentCard(order);
                });
                html += '</div>';
                activeContainer.innerHTML = html;
            }
            
            // Рендерим историю записей
            if (historyOrders.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <p>История записей пуста</p>
                    </div>
                `;
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                historyOrders.forEach(order => {
                    html += renderAppointmentCard(order, true);
                });
                html += '</div>';
                historyContainer.innerHTML = html;
            }
        }

        // Функция для рендеринга карточки записи
        function renderAppointmentCard(order, isHistory = false) {
            const firstService = order.services[0];
            const orderDate = new Date(order.date).toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            let servicesHTML = '';
            order.services.forEach((service, index) => {
                const serviceDate = new Date(service.date).toLocaleDateString('ru-RU', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
                const durationHours = Math.floor(service.duration / 60);
                const durationMinutes = service.duration % 60;
                const durationText = `${durationHours}ч ${durationMinutes > 0 ? durationMinutes + 'м' : ''}`;
                
                servicesHTML += `
                    <div style="background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">${service.service}</div>
                                <div style="color: #888; font-size: 13px;">${serviceDate} в ${service.time}</div>
                                <div style="color: #888; font-size: 13px;">Длительность: ${durationText}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: #0078D4;">${service.price} ₽</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const statusText = order.status === 'confirmed' || order.approved ? 'Подтверждена' : 
                              order.status === 'cancelled' ? 'Отменена' : 'Ожидает подтверждения';
            const statusColor = order.status === 'confirmed' || order.approved ? '#00a86b' : 
                               order.status === 'cancelled' ? '#ff4444' : '#ffa500';
            
            return `
                <div style="background: #1a1a1a; border-radius: 16px; padding: 16px; border: 1px solid #2a2a2a;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Заказ #${order.id}</div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${firstService?.service || 'Услуга'}</div>
                            <div style="font-size: 13px; color: #888;">${orderDate}</div>
                        </div>
                        <div style="padding: 4px 12px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        ${servicesHTML}
                    </div>
                    
                    ${order.wishes ? `
                        <div style="background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                            <strong style="color: #0078D4;">Пожелания:</strong>
                            <div style="color: #ccc; margin-top: 4px;">${order.wishes}</div>
                        </div>
                    ` : ''}
                    
                    ${order.photo ? `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #0078D4; font-size: 13px;">Фото-пример прикреплено</strong>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2a2a2a;">
                        <div>
                            <div style="font-size: 12px; color: #888;">Дата оформления:</div>
                            <div style="font-size: 13px;">${orderDate}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #888;">Итого:</div>
                            <div style="font-size: 18px; font-weight: 700; color: #0078D4;">${order.total} ₽</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== СИСТЕМА УЧЕТА ЗАРАБОТКА ==========
        function updateEarningsStats(order) {
            const today = new Date().toISOString().split('T')[0];
            
            // Обновляем дневную статистику
            if (!earningsStats.daily[today]) {
                earningsStats.daily[today] = { earnings: 0, orders: 0 };
            }
            earningsStats.daily[today].earnings += order.total;
            earningsStats.daily[today].orders += 1;
            
            // Обновляем общую статистику
            earningsStats.total += order.total;
            
            // Сохраняем
            localStorage.setItem('earningsStats', JSON.stringify(earningsStats));
        }

        // ========== ГАЛЕРЕЯ РАБОТ ==========
        function updateWorksDisplay() {
            const worksGrid = document.querySelector('#main .works-grid');
            if (worksGrid) {
                let html = '';
                worksGallery.forEach((photo, index) => {
                    html += `
                        <div class="work-card" style="background-image: url(${photo})">
                            <div style="opacity: 0;">${index + 1}</div>
                        </div>
                    `;
                });
                
                // Добавляем placeholder если фото мало
                const currentCount = worksGallery.length;
                for (let i = currentCount; i < 6; i++) {
                    html += `
                        <div class="work-card" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white;">
                            ${i + 1}
                        </div>
                    `;
                }
                
                worksGrid.innerHTML = html;
            }
        }

        function openPhotoManager() {
            const modal = document.getElementById('photoManagerModal');
            modal.classList.add('active');
            renderWorksGallery();
        }

        function closePhotoManager() {
            const modal = document.getElementById('photoManagerModal');
            modal.classList.remove('active');
        }

        function renderWorksGallery() {
            const container = document.getElementById('worksGallery');
            let html = '';
            
            worksGallery.forEach((photo, index) => {
                html += `
                    <div class="work-card" style="background-image: url(${photo})">
                        <div class="delete-photo-btn" onclick="deleteWorkPhoto(${index})">×</div>
                    </div>
                `;
            });
            
            // Добавляем кнопку для новой фото
            html += `
                <div class="work-card" style="background: #333; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; font-size: 24px;" onclick="addWorkPhoto()">
                    +
                </div>
            `;
            
            container.innerHTML = html;
        }

        function addWorkPhoto() {
            const imageUrl = prompt('Введите URL изображения для добавления в галерею:');
            if (imageUrl && imageUrl.startsWith('http')) {
                worksGallery.push(imageUrl);
                localStorage.setItem('worksGallery', JSON.stringify(worksGallery));
                renderWorksGallery();
                updateWorksDisplay();
                showNotification('Фото добавлено в галерею!', 'success');
            } else if (imageUrl) {
                showNotification('Пожалуйста, введите корректный URL (должен начинаться с http или https)', 'error');
            }
        }

        function deleteWorkPhoto(index) {
            if (confirm('Удалить это фото из галереи?')) {
                worksGallery.splice(index, 1);
                localStorage.setItem('worksGallery', JSON.stringify(worksGallery));
                renderWorksGallery();
                updateWorksDisplay();
                showNotification('Фото удалено!', 'success');
            }
        }

        // ========== СИСТЕМА ОТЗЫВОВ (ОБНОВЛЕНА - АВТОМАТИЧЕСКОЕ ИМЯ ИЗ TELEGRAM) ==========
        function initReviewForm() {
            const form = document.getElementById('reviewForm');
            const stars = document.querySelectorAll('.rating-stars .star');
            let selectedRating = 0;

            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('selectedRating').value = selectedRating;
                    
                    stars.forEach(s => {
                        const rating = parseInt(s.getAttribute('data-rating'));
                        if (rating <= selectedRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Автоматическое имя из Telegram
                const name = user?.username ? `@${user.username}` : (user?.first_name || "Клиент");
                const rating = parseInt(document.getElementById('selectedRating').value);
                const text = document.getElementById('reviewText').value.trim();

                if (!rating || !text) {
                    showNotification('Пожалуйста, выберите оценку и напишите отзыв', 'error');
                    return;
                }

                const review = {
                    name: name,
                    rating: rating,
                    text: text,
                    date: new Date().toLocaleDateString('ru-RU'),
                    avatarColor: getRandomGradient(),
                    userId: user?.id || null
                };

                reviews.push(review);
                localStorage.setItem('reviews', JSON.stringify(reviews));
                
                form.reset();
                stars.forEach(s => s.classList.remove('active'));
                selectedRating = 0;
                document.getElementById('selectedRating').value = '';
                
                renderReviews();
                showNotification('Спасибо за ваш отзыв!', 'success');
            });
        }

        function renderReviews() {
            const container = document.getElementById('reviewsContainer');
            let html = '';
            
            if (reviews.length === 0) {
                html = '<div class="empty-state"><p>Пока нет отзывов. Будьте первым!</p></div>';
            } else {
                reviews.forEach((review, index) => {
                    html += `
                        <div class="review-card">
                            <div class="review-header">
                                <div class="avatar-rect reviewer-avatar" style="background: ${review.avatarColor || 'linear-gradient(135deg, #667eea, #764ba2)'};">
                                    <div class="avatar-content">${review.name.charAt(0)}</div>
                                </div>
                                <div class="reviewer-info">
                                    <span class="reviewer-name">${review.name}</span>
                                    <span class="review-date">${review.date}</span>
                                </div>
                                <div class="review-rating">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</div>
                            </div>
                            <p class="review-text">${review.text}</p>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            updateReviewsStats();
        }

        function updateReviewsStats() {
            const ratingNumber = document.querySelector('.rating-number');
            const reviewsCount = document.querySelector('.reviews-count');
            
            if (reviews.length === 0) {
                ratingNumber.textContent = '-';
                reviewsCount.textContent = '0 отзывов';
            } else {
                const averageRating = reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length;
                ratingNumber.textContent = averageRating.toFixed(1);
                reviewsCount.textContent = `${reviews.length} ${getReviewWord(reviews.length)}`;
            }
        }

        function getReviewWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return 'отзыв';
            if ([2,3,4].includes(count % 10) && ![12,13,14].includes(count % 100)) return 'отзыва';
            return 'отзывов';
        }

        function getRandomGradient() {
            const gradients = [
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #ff6b6b, #ffa8a8)',
                'linear-gradient(135deg, #4ecdc4, #44a08d)',
                'linear-gradient(135deg, #96ceb4, #ffeead)',
                'linear-gradient(135deg, #ff9a9e, #fad0c4)'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        // ========== ФУНКЦИИ УПРАВЛЕНИЯ ЧАТОМ ==========

        // Ограничение истории чата
        function manageChatStorage() {
            const now = new Date();
            const cutoffDate = new Date(now);
            cutoffDate.setDate(cutoffDate.getDate() - CHAT_CONFIG.MAX_DAYS);

            // Фильтруем по дате
            Object.keys(chats).forEach(chatId => {
                chats[chatId].messages = chats[chatId].messages.filter(msg => new Date(msg.timestamp) > cutoffDate);

                // Ограничение по общему количеству сообщений
                if (chats[chatId].messages.length > CHAT_CONFIG.MAX_MESSAGES) {
                    chats[chatId].messages = chats[chatId].messages.slice(-CHAT_CONFIG.MAX_MESSAGES);
                }

                // Ограничение по количеству фото
                const photoMessages = chats[chatId].messages.filter(msg => msg.photo);
                if (photoMessages.length > CHAT_CONFIG.MAX_PHOTOS) {
                    const photosToRemove = photoMessages.slice(0, photoMessages.length - CHAT_CONFIG.MAX_PHOTOS);
                    const idsToRemove = photosToRemove.map(msg => msg.id);
                    chats[chatId].messages = chats[chatId].messages.filter(msg => !idsToRemove.includes(msg.id));
                }
            });

            // Проверка общего размера хранилища
            enforceStorageLimit();

            // Сохраняем обновленную историю
            saveChats();
            updateChatStats();
        }

        // Принудительное ограничение размера хранилища
        function enforceStorageLimit() {
            let currentSize = new Blob([JSON.stringify(chats)]).size;
            
            while (currentSize > CHAT_CONFIG.MAX_STORAGE_SIZE && Object.keys(chats).length > 1) {
                // Удаляем самый старый чат
                let oldestChatId = null;
                let oldestDate = new Date();
                
                Object.keys(chats).forEach(chatId => {
                    const chatDate = new Date(chats[chatId].info.lastActivity);
                    if (chatDate < oldestDate) {
                        oldestDate = chatDate;
                        oldestChatId = chatId;
                    }
                });
                
                if (oldestChatId) {
                    delete chats[oldestChatId];
                    currentSize = new Blob([JSON.stringify(chats)]).size;
                } else {
                    break;
                }
            }
        }

        // Сжатие изображения
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    
                    // Масштабируем если нужно
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Рисуем сжатое изображение
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Конвертируем в base64 с качеством
                    try {
                        const compressedData = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Статистика чата
        function updateChatStats() {
            const stats = calculateChatStats();
            const container = document.getElementById('chatStats');
            
            if (!container) return;
            
            let storageWarning = '';
            const storagePercentage = (stats.storageSize / CHAT_CONFIG.MAX_STORAGE_SIZE) * 100;
            
            if (storagePercentage > 80) {
                storageWarning = `<div class="storage-warning storage-critical">
                    Внимание! Хранилище почти заполнено! Рекомендуется очистить историю.
                </div>`;
            } else if (storagePercentage > 60) {
                storageWarning = `<div class="storage-warning">
                    Хранилище заполнено на ${Math.round(storagePercentage)}%. Следите за размером.
                </div>`;
            }
            
            container.innerHTML = `
                <div class="stat-row">
                    <span>Всего чатов:</span>
                    <span class="stat-value">${stats.totalChats}</span>
                </div>
                <div class="stat-row">
                    <span>Всего сообщений:</span>
                    <span class="stat-value">${stats.totalMessages}</span>
                </div>
                <div class="stat-row">
                    <span>С фото:</span>
                    <span class="stat-value">${stats.photoMessages}</span>
                </div>
                <div class="stat-row">
                    <span>Размер хранилища:</span>
                    <span class="stat-value">${(stats.storageSize / 1024).toFixed(1)} КБ</span>
                </div>
                ${storageWarning}
            `;
        }

        function calculateChatStats() {
            let totalMessages = 0;
            let photoMessages = 0;
            
            Object.values(chats).forEach(chat => {
                totalMessages += chat.messages.length;
                photoMessages += chat.messages.filter(msg => msg.photo).length;
            });
            
            return {
                totalChats: Object.keys(chats).length,
                totalMessages: totalMessages,
                photoMessages: photoMessages,
                storageSize: new Blob([JSON.stringify(chats)]).size
            };
        }

        // Экспорт истории чата
        function exportChatHistory() {
            const dataStr = JSON.stringify(chats, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-history-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('История чата экспортирована!', 'success');
        }

        // Очистка старых сообщений
        function clearOldMessages() {
            if (confirm('Удалить сообщения старше 7 дней?')) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - 7);
                
                let removedCount = 0;
                Object.keys(chats).forEach(chatId => {
                    const initialCount = chats[chatId].messages.length;
                    chats[chatId].messages = chats[chatId].messages.filter(msg => new Date(msg.timestamp) > cutoffDate);
                    removedCount += (initialCount - chats[chatId].messages.length);
                });
                
                saveChats();
                renderChatsList();
                updateChatStats();
                
                showNotification(`Удалено ${removedCount} старых сообщений`, 'success');
            }
        }

        // Полная очистка чата
        function clearEntireChat() {
            if (confirm('ВЫ УВЕРЕНЫ? Это полностью очистит всю историю чатов!')) {
                chats = {};
                saveChats();
                renderChatsList();
                updateChatStats();
                showNotification('История чатов полностью очищена!', 'success');
            }
        }

        // Настройки чата
        function showChatSettings() {
            const modal = document.getElementById('chatSettingsModal');
            modal.classList.add('active');
            
            // Заполняем текущие настройки
            document.getElementById('maxMessages').value = CHAT_CONFIG.MAX_MESSAGES;
            document.getElementById('maxDays').value = CHAT_CONFIG.MAX_DAYS;
            document.getElementById('maxPhotos').value = CHAT_CONFIG.MAX_PHOTOS;
            document.getElementById('compressImages').checked = CHAT_CONFIG.COMPRESS_IMAGES;
            document.getElementById('imageQuality').value = CHAT_CONFIG.IMAGE_QUALITY * 100;
            document.getElementById('qualityValue').textContent = `${CHAT_CONFIG.IMAGE_QUALITY * 100}%`;
            
            // Обработчик для ползунка качества
            document.getElementById('imageQuality').addEventListener('input', function() {
                document.getElementById('qualityValue').textContent = `${this.value}%`;
            });
        }

        function closeChatSettings() {
            document.getElementById('chatSettingsModal').classList.remove('active');
        }

        function saveChatSettings() {
            CHAT_CONFIG.MAX_MESSAGES = parseInt(document.getElementById('maxMessages').value) || 200;
            CHAT_CONFIG.MAX_DAYS = parseInt(document.getElementById('maxDays').value) || 30;
            CHAT_CONFIG.MAX_PHOTOS = parseInt(document.getElementById('maxPhotos').value) || 50;
            CHAT_CONFIG.COMPRESS_IMAGES = document.getElementById('compressImages').checked;
            CHAT_CONFIG.IMAGE_QUALITY = parseInt(document.getElementById('imageQuality').value) / 100;
            
            localStorage.setItem('chatConfig', JSON.stringify(CHAT_CONFIG));
            
            // Применяем новые ограничения
            manageChatStorage();
            renderChatsList();
            
            closeChatSettings();
            showNotification('Настройки чата сохранены!', 'success');
        }

        // Функции для работы с фото в чате
        function viewPhoto(photoData) {
            window.open(photoData, '_blank');
        }

        function downloadPhoto(photoData) {
            const link = document.createElement('a');
            link.href = photoData;
            link.download = `chat-photo-${Date.now()}.jpg`;
            link.click();
        }

        // Редактирование сообщения
        function editMessage(messageId, chatId) {
            if (!chats[chatId]) return;
            
            const message = chats[chatId].messages.find(m => m.id === messageId);
            if (!message || !message.text) return;
            
            const newText = prompt('Редактировать сообщение:', message.text);
            if (newText === null || newText.trim() === '') return;
            
            message.text = newText.trim();
            message.edited = true;
            message.editTime = new Date().toISOString();
            
            saveChats();
            
            // Обновляем интерфейс
            if (isMaster) {
                renderMasterChatMessages();
            } else {
                renderChatMessages();
            }
            
            showNotification('Сообщение отредактировано', 'success');
        }

        // Удаление сообщения
        function deleteMessage(messageId, chatId) {
            if (!confirm('Удалить это сообщение?')) return;
            
            if (!chats[chatId]) return;
            
            const messageIndex = chats[chatId].messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            chats[chatId].messages.splice(messageIndex, 1);
            saveChats();
            
            // Обновляем интерфейс
            if (isMaster) {
                renderMasterChatMessages();
            } else {
                renderChatMessages();
            }
            
            showNotification('Сообщение удалено', 'success');
        }

        // ========== НАСТРОЙКИ СООБЩЕНИЙ ОБ ОДОБРЕНИИ ==========
        function openApprovalSettings() {
            const modal = document.getElementById('approvalSettingsModal');
            modal.classList.add('active');
            
            // Заполняем текущие настройки
            document.getElementById('approvedMessageText').value = approvalSettings.approvedMessage;
            document.getElementById('rejectedMessageText').value = approvalSettings.rejectedMessage;
            document.getElementById('approvalAddress').value = approvalSettings.address;
            document.getElementById('approvalPayment').value = approvalSettings.payment;
        }

        function closeApprovalSettings() {
            document.getElementById('approvalSettingsModal').classList.remove('active');
        }

        function saveApprovalSettings() {
            approvalSettings.approvedMessage = document.getElementById('approvedMessageText').value.trim();
            approvalSettings.rejectedMessage = document.getElementById('rejectedMessageText').value.trim();
            approvalSettings.address = document.getElementById('approvalAddress').value.trim();
            approvalSettings.payment = document.getElementById('approvalPayment').value.trim();
            
            localStorage.setItem('approvalSettings', JSON.stringify(approvalSettings));
            closeApprovalSettings();
            updateApprovalSettingsPreview();
            showNotification('Настройки сообщений сохранены!', 'success');
        }

        function updateApprovalSettingsPreview() {
            const addressEl = document.getElementById('previewAddress');
            const paymentEl = document.getElementById('previewPayment');
            if (addressEl) addressEl.textContent = approvalSettings.address || 'Не указан';
            if (paymentEl) paymentEl.textContent = approvalSettings.payment || 'Не указаны';
        }

        // ========== УПРАВЛЕНИЕ СВОБОДНЫМ ВРЕМЕНЕМ ==========
        let freeTimeSlots = JSON.parse(localStorage.getItem('freeTimeSlots')) || [];

        function openFreeTimeManager() {
            const modal = document.getElementById('freeTimeModal');
            modal.classList.add('active');
            renderFreeTimeSlots();
            
            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('freeTimeDate').value = today;
        }

        function closeFreeTimeManager() {
            document.getElementById('freeTimeModal').classList.remove('active');
        }

        function saveFreeTimeSlot() {
            const date = document.getElementById('freeTimeDate').value;
            const start = document.getElementById('freeTimeStart').value;
            const end = document.getElementById('freeTimeEnd').value;
            
            if (!date || !start || !end) {
                showNotification('Заполните все поля', 'error');
                return;
            }
            
            if (start >= end) {
                showNotification('Время окончания должно быть позже времени начала', 'error');
                return;
            }
            
            const newSlot = {
                id: Date.now(),
                date: date,
                startTime: start,
                endTime: end,
                enabled: true
            };
            
            freeTimeSlots.push(newSlot);
            localStorage.setItem('freeTimeSlots', JSON.stringify(freeTimeSlots));
            
            document.getElementById('freeTimeDate').value = '';
            document.getElementById('freeTimeStart').value = '';
            document.getElementById('freeTimeEnd').value = '';
            
            renderFreeTimeSlots();
            updateFreeTimePreview();
            showNotification('Свободное время добавлено!', 'success');
        }

        function renderFreeTimeSlots() {
            const container = document.getElementById('freeTimeSlotsList');
            if (!container) return;
            
            if (freeTimeSlots.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Нет добавленных слотов</p>';
                return;
            }
            
            let html = '<h4 style="margin-bottom: 12px;">Добавленные слоты:</h4>';
            
            // Группируем по дате
            const slotsByDate = {};
            freeTimeSlots.forEach(slot => {
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });
            
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('ru-RU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
                
                html += `<div style="margin-bottom: 12px; padding: 12px; background: #252525; border-radius: 8px;">`;
                html += `<strong>${dateStr}</strong>`;
                
                slotsByDate[date].forEach(slot => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding: 8px; background: #1a1a1a; border-radius: 6px;">
                            <span>${slot.startTime} - ${slot.endTime}</span>
                            <button class="photo-action-btn" onclick="deleteFreeTimeSlot(${slot.id})" title="Удалить">Уд</button>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function deleteFreeTimeSlot(slotId) {
            if (confirm('Удалить этот слот свободного времени?')) {
                freeTimeSlots = freeTimeSlots.filter(slot => slot.id !== slotId);
                localStorage.setItem('freeTimeSlots', JSON.stringify(freeTimeSlots));
                renderFreeTimeSlots();
                updateFreeTimePreview();
                showNotification('Слот удален', 'success');
            }
        }

        function viewFreeTimeSlots() {
            openFreeTimeManager();
        }

        function updateFreeTimePreview() {
            const container = document.getElementById('freeTimePreview');
            if (!container) return;
            
            const activeSlots = freeTimeSlots.filter(slot => {
                const slotDate = new Date(slot.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return slotDate >= today && slot.enabled;
            });
            
            if (activeSlots.length === 0) {
                container.innerHTML = '<p>Нет активных слотов свободного времени</p>';
            } else {
                container.innerHTML = `<p>Активных слотов: <strong>${activeSlots.length}</strong></p>`;
            }
        }

        // ========== УПРАВЛЕНИЕ ЧАТАМИ ==========
        function openChatManager() {
            const modal = document.getElementById('chatManagerModal');
            modal.classList.add('active');
            renderChatsManagerList();
        }

        function closeChatManager() {
            document.getElementById('chatManagerModal').classList.remove('active');
        }

        function renderChatsManagerList() {
            const container = document.getElementById('chatsManagerList');
            if (!container) return;
            
            if (Object.keys(chats).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Нет активных чатов</p>';
                return;
            }
            
            let html = '';
            Object.values(chats)
                .sort((a, b) => new Date(b.info.lastActivity) - new Date(a.info.lastActivity))
                .forEach(chat => {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    const lastMessageText = lastMessage?.photo ? 'Фото' : (lastMessage?.text?.substring(0, 30) || 'Нет сообщений');
                    const lastMessageTime = lastMessage ? formatTime(lastMessage.timestamp) : '';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #252525; border-radius: 8px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${chat.info.name}</div>
                                <div style="font-size: 12px; color: #888;">${lastMessageText}</div>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">${lastMessageTime}</div>
                            </div>
                            <button class="photo-action-btn" style="background: #ff4444;" onclick="deleteChat('${chat.info.id}')" title="Удалить чат">Уд</button>
                        </div>
                    `;
                });
            
            container.innerHTML = html;
        }

        function deleteChat(chatId) {
            if (confirm(`Удалить чат с ${chats[chatId]?.info.name}? Все сообщения будут удалены!`)) {
                delete chats[chatId];
                saveChats();
                renderChatsManagerList();
                renderChatsList();
                updateChatStats();
                showNotification('Чат удален', 'success');
            }
        }

        // ========== АДМИН-ПАНЕЛЬ (ДОБАВЛЕН РАЗДЕЛ ГРАФИКА РАБОТЫ) ==========
        function updateAdminSchedule() {
            const scheduleList = document.getElementById('scheduleList');
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            
            scheduleList.innerHTML = '';
            
            if (orders.length === 0) {
                scheduleList.innerHTML = '<p>Нет активных записей</p>';
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Категоризируем записи
            const newOrders = []; // Подтвержденные/ожидание, будущие
            const oldOrders = []; // Завершенные, прошедшие
            const missedOrders = []; // Пропущенные
            
            orders.forEach(order => {
                const firstService = order.services[0];
                const serviceDate = new Date(firstService.date);
                const serviceDateTime = new Date(`${firstService.date}T${firstService.time}`);
                
                // Определяем категорию
                if (serviceDateTime < now) {
                    // Прошедшая запись
                    if (order.attended === false || (order.status === 'confirmed' && !order.attended && serviceDate < today)) {
                        missedOrders.push(order);
                    } else {
                        oldOrders.push(order);
                    }
                } else {
                    // Будущая запись
                    newOrders.push(order);
                }
            });
            
            // Сортируем новые по дате и времени
            newOrders.sort((a, b) => {
                const dateA = new Date(`${a.services[0].date}T${a.services[0].time}`);
                const dateB = new Date(`${b.services[0].date}T${b.services[0].time}`);
                return dateA - dateB;
            });
            
            // Сортируем старые по дате (новые сверху)
            oldOrders.sort((a, b) => {
                const dateA = new Date(`${a.services[0].date}T${a.services[0].time}`);
                const dateB = new Date(`${b.services[0].date}T${b.services[0].time}`);
                return dateB - dateA;
            });
            
            // Сортируем пропущенные по дате (новые сверху)
            missedOrders.sort((a, b) => {
                const dateA = new Date(`${a.services[0].date}T${a.services[0].time}`);
                const dateB = new Date(`${b.services[0].date}T${b.services[0].time}`);
                return dateB - dateA;
            });
            
                // Рендерим пропущенные записи (красные, сверху)
            if (missedOrders.length > 0) {
                const missedSection = document.createElement('div');
                missedSection.innerHTML = '<h4 style="color: #ff4444; margin: 16px 0 8px 0; font-size: 14px;">Пропущенные записи</h4>';
                scheduleList.appendChild(missedSection);
                
                missedOrders.forEach(order => {
                    scheduleList.appendChild(createOrderElement(order, 'missed'));
                });
            }
            
            // Рендерим новые записи
            if (newOrders.length > 0) {
                const newSection = document.createElement('div');
                newSection.innerHTML = '<h4 style="color: #0078D4; margin: 16px 0 8px 0; font-size: 14px;">Активные записи</h4>';
                scheduleList.appendChild(newSection);
                
                newOrders.forEach(order => {
                    scheduleList.appendChild(createOrderElement(order, 'new'));
                });
            }
            
            // Рендерим старые записи (тусклые)
            if (oldOrders.length > 0) {
                const oldSection = document.createElement('div');
                oldSection.innerHTML = '<h4 style="color: #888; margin: 16px 0 8px 0; font-size: 14px;">Завершенные записи</h4>';
                scheduleList.appendChild(oldSection);
                
                oldOrders.forEach(order => {
                    scheduleList.appendChild(createOrderElement(order, 'old'));
                });
            }
            
            // Проверяем напоминания за день
            checkUpcomingReminders(newOrders);
            
            updateAdminStats();
        }

        // Создание элемента заказа
        function createOrderElement(order, category) {
            const orderElement = document.createElement('div');
            const firstService = order.services[0];
            const serviceDate = new Date(firstService.date);
            const serviceDateTime = new Date(`${firstService.date}T${firstService.time}`);
            const now = new Date();
            const isUpcoming = serviceDateTime > now;
            const isToday = serviceDate.toDateString() === new Date().toDateString();
            const isTomorrow = serviceDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
            
            // Стили в зависимости от категории
            let itemStyle = '';
            let opacity = '1';
            if (category === 'old') {
                opacity = '0.6';
                itemStyle = 'background: #1a1a1a; border-color: #333;';
            } else if (category === 'missed') {
                itemStyle = 'background: #2a1a1a; border-color: #ff4444; border-left: 3px solid #ff4444;';
            }
            
            // Напоминание за день
            let reminderBadge = '';
            if (isTomorrow && isUpcoming && order.status === 'confirmed') {
                reminderBadge = '<span style="background: #ffa500; color: black; padding: 2px 8px; border-radius: 8px; font-size: 10px; margin-left: 8px;">Завтра</span>';
            }
            
            orderElement.className = 'schedule-item';
            orderElement.style.cssText = itemStyle + `opacity: ${opacity};`;
            
            // Статус прихода
            let attendanceStatus = '';
            if (order.attended === true) {
                attendanceStatus = '<span style="color: #00a86b; font-size: 12px;">✓ Пришел</span>';
            } else if (order.attended === false) {
                attendanceStatus = '<span style="color: #ff4444; font-size: 12px;">✗ Не пришел</span>';
            }
            
            // Получаем уровень клиента
            const clientLevel = getClientLoyaltyLevelFromOrder(order);
            const levelNames = ['Начинающий', 'Знаток в маникюре', 'Фанатка nailsq', 'Элита nailsq'];
            const clientLevelName = levelNames[clientLevel] || 'Клиент';
            
            // Вычисляем цены с учетом скидки и предоплаты
            const discount = getClientDiscount(clientLevel);
            const servicePrices = order.services.map(service => {
                const originalPrice = service.price;
                const discountedPrice = discount > 0 ? Math.round(originalPrice * (1 - discount / 100)) : originalPrice;
                const priceWithoutPrepayment = discountedPrice - 500; // Цена без предоплаты для мастера
                return { originalPrice, discountedPrice, priceWithoutPrepayment, discount };
            });
            
            orderElement.innerHTML = `
                <div class="order-info">
                    <div class="client-info">
                        <div class="client-name">${order.client.name} ${reminderBadge}</div>
                        <div class="client-username">${order.client.username}</div>
                        <div style="font-size: 11px; color: #888;">ID: ${order.client.userId} | Уровень: ${clientLevelName}</div>
                    </div>
                    <div class="order-header">
                        <strong>Заказ #${order.id}</strong>
                        <span class="order-status ${order.status}">${getStatusText(order.status)}</span>
                        ${attendanceStatus}
                    </div>
                    <div class="order-services">
                        ${order.services.map((service, index) => {
                            const sDate = new Date(service.date);
                            const readableDate = sDate.toLocaleDateString('ru-RU', {
                                weekday: 'short',
                                day: 'numeric',
                                month: 'short'
                            });
                            const priceInfo = servicePrices[index];
                            let priceDisplay = '';
                            if (priceInfo.discount > 0) {
                                priceDisplay = `<span style="text-decoration: line-through; color: #888; margin-right: 8px;">${priceInfo.originalPrice} ₽</span><span style="color: #00a86b; font-weight: 600;">${priceInfo.priceWithoutPrepayment} ₽</span> <span style="color: #00a86b; font-size: 11px;">(скидка ${priceInfo.discount}%)</span>`;
                            } else {
                                priceDisplay = `${priceInfo.priceWithoutPrepayment} ₽`;
                            }
                            return `
                                <div class="service-line">
                                    <span>${service.service}</span>
                                    <span>${readableDate} в ${service.time}</span>
                                    <span>${priceDisplay}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${order.wishes ? `<div class="order-wishes">${order.wishes}</div>` : ''}
                    ${order.photo ? `<div class="order-photo">Есть фото-пример</div>` : ''}
                    <div class="order-total">Итого: ${order.total - 500} ₽ (без предоплаты)</div>
                </div>
                <div class="order-actions">
                    ${isUpcoming ? `
                        <button class="status-btn" onclick="changeOrderStatus(${order.id}, 'confirmed')" title="Подтвердить">Ок</button>
                        <button class="status-btn" onclick="changeOrderStatus(${order.id}, 'cancelled')" title="Отменить">Отм</button>
                    ` : ''}
                    ${!isUpcoming && order.status === 'confirmed' && order.attended === undefined ? `
                        <button class="status-btn" style="background: #00a86b;" onclick="markAttendance(${order.id}, true)" title="Отметить приход">✓</button>
                        <button class="status-btn" style="background: #ff4444;" onclick="markAttendance(${order.id}, false)" title="Отметить неприход">✗</button>
                    ` : ''}
                    <button class="remove-from-cart" onclick="deleteOrder(${order.id})">Удалить</button>
                </div>
            `;
            
            return orderElement;
        }

        // Отметка прихода/неприхода
        function markAttendance(orderId, attended) {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex].attended = attended;
                orders[orderIndex].attendanceDate = new Date().toISOString();
                localStorage.setItem('masterOrders', JSON.stringify(orders));
                updateAdminSchedule();
                showNotification(`Клиент ${attended ? 'отмечен как пришедший' : 'отмечен как не пришедший'}`, 'success');
            }
        }

        // Проверка напоминаний за день
        function checkUpcomingReminders(orders) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const tomorrowOrders = orders.filter(order => {
                const firstService = order.services[0];
                return firstService.date === tomorrowStr && order.status === 'confirmed';
            });
            
            if (tomorrowOrders.length > 0) {
                const reminderKey = `reminder_${tomorrowStr}`;
                const lastReminder = localStorage.getItem(reminderKey);
                const todayStr = new Date().toISOString().split('T')[0];
                
                if (lastReminder !== todayStr) {
                    showNotification(`Напоминание: Завтра ${tomorrowOrders.length} ${tomorrowOrders.length === 1 ? 'запись' : 'записей'}`, 'info');
                    localStorage.setItem(reminderKey, todayStr);
                }
            }
        }

        function updateAdminStats() {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const today = new Date();
            
            let stats = {
                today: { orders: 0, earnings: 0 },
                week: { orders: 0, earnings: 0 },
                month: { orders: 0, earnings: 0 },
                total: { orders: orders.length, earnings: 0 }
            };

            // Считаем общую выручку
            stats.total.earnings = orders.reduce((sum, order) => sum + order.total, 0);

            // Считаем по периодам
            orders.forEach(order => {
                const orderDate = new Date(order.date);
                
                // Сегодня
                if (orderDate.toDateString() === today.toDateString()) {
                    stats.today.orders++;
                    stats.today.earnings += order.total;
                }
                
                // Неделя (последние 7 дней)
                const weekAgo = new Date();
                weekAgo.setDate(today.getDate() - 7);
                if (orderDate >= weekAgo) {
                    stats.week.orders++;
                    stats.week.earnings += order.total;
                }
                
                // Месяц (последние 30 дней)
                const monthAgo = new Date();
                monthAgo.setDate(today.getDate() - 30);
                if (orderDate >= monthAgo) {
                    stats.month.orders++;
                    stats.month.earnings += order.total;
                }
            });

            updateStatsDisplay(stats);
        }

        function updateStatsDisplay(stats) {
            const container = document.getElementById('adminStatsContainer');
            if (!container) return;
            
            let html = '';
            
            if (statsSettings.today) {
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${stats.today.orders}</div>
                        <div class="stat-label">Сегодня</div>
                        <div class="stat-earnings">${stats.today.earnings} ₽</div>
                    </div>
                `;
            }
            
            if (statsSettings.week) {
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${stats.week.orders}</div>
                        <div class="stat-label">Неделя</div>
                        <div class="stat-earnings">${stats.week.earnings} ₽</div>
                    </div>
                `;
            }
            
            if (statsSettings.month) {
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${stats.month.orders}</div>
                        <div class="stat-label">Месяц</div>
                        <div class="stat-earnings">${stats.month.earnings} ₽</div>
                    </div>
                `;
            }
            
            if (statsSettings.total) {
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total.orders}</div>
                        <div class="stat-label">Всего</div>
                        <div class="stat-earnings">${stats.total.earnings} ₽</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function getStatusText(status) {
            const statuses = {
                'pending': 'Ожидание',
                'confirmed': 'Подтвержден',
                'cancelled': 'Отменен'
            };
            return statuses[status] || status;
        }

        function changeOrderStatus(orderId, newStatus) {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                const order = orders[orderIndex];
                const oldStatus = order.status;
                orders[orderIndex].status = newStatus;
                
                // Если статус изменен на "confirmed", одобряем запись и отправляем сообщение
                if (newStatus === 'confirmed' && !order.approved) {
                    orders[orderIndex].approved = true;
                    sendApprovalMessage(order);
                    activateChatForOrder(order);
                } else if (newStatus === 'cancelled' && oldStatus !== 'cancelled') {
                    sendRejectionMessage(order);
                }
                
                localStorage.setItem('masterOrders', JSON.stringify(orders));
                updateAdminSchedule();
                updateClientAppointments(); // Обновляем список заказов клиента
                showNotification(`Статус заказа #${orderId} изменен на "${getStatusText(newStatus)}"`, 'success');
            }
        }

        function deleteOrder(orderId) {
            if (!confirm('Вы уверены, что хотите удалить этот заказ?')) {
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                const order = orders[orderIndex];
                
                // Удаляем из забронированных слотов
                bookedSlots = bookedSlots.filter(slot => slot.orderId !== orderId);
                saveBookedSlots();
                
                // Удаляем заказ
                orders.splice(orderIndex, 1);
                localStorage.setItem('masterOrders', JSON.stringify(orders));
                
                updateAdminSchedule();
                updateClientAppointments();
                showNotification('Заказ удален', 'success');
            }
        }

        // ========== PUSH-УВЕДОМЛЕНИЯ ==========
        function sendPushNotification(order, type) {
            const firstService = order.services[0];
            const serviceDate = new Date(firstService.date);
            const dateStr = serviceDate.toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
            
            let message = '';
            if (type === 'reminder') {
                message = `Напоминание: Завтра (${dateStr}) в ${firstService.time} у вас запись на ${firstService.service}`;
            } else if (type === 'approved') {
                message = `Ваша запись подтверждена на ${dateStr} в ${firstService.time}`;
            } else if (type === 'rejected') {
                message = `Ваша запись на ${dateStr} не может быть подтверждена`;
            }
            
            // Используем Telegram уведомления если доступны
            if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                tg.showAlert(message);
            } else {
                showNotification(message, type === 'rejected' ? 'error' : 'success');
            }
            
            // Также отправляем в чат если есть
            const clientId = getClientIdFromOrder(order);
            if (clientId && chats[clientId]) {
                const notificationMessage = {
                    id: Date.now(),
                    text: message,
                    sender: 'master',
                    timestamp: new Date().toISOString(),
                    read: false,
                    isSystem: true
                };
                
                chats[clientId].messages.push(notificationMessage);
                chats[clientId].info.unreadCount = (chats[clientId].info.unreadCount || 0) + 1;
                saveChats();
            }
        }

        // Отправка сообщения об одобрении
        function sendApprovalMessage(order) {
            const clientId = getClientIdFromOrder(order);
            if (!clientId) return;
            
            // Создаем или получаем чат
            if (!chats[clientId]) {
                createNewChat(clientId, order.client.name);
            }
            
            // Формируем сообщение
            const firstService = order.services[0];
            const serviceDate = new Date(firstService.date).toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
            const serviceTime = firstService.time;
            const servicesList = order.services.map(s => `• ${s.service} - ${s.price} ₽`).join('\n');
            
            let message = approvalSettings.approvedMessage
                .replace(/{date}/g, serviceDate)
                .replace(/{time}/g, serviceTime)
                .replace(/{services}/g, servicesList)
                .replace(/{address}/g, approvalSettings.address)
                .replace(/{payment}/g, approvalSettings.payment);
            
            // Добавляем сообщение в чат
            const newMessage = {
                id: Date.now(),
                text: message,
                sender: 'master',
                timestamp: new Date().toISOString(),
                read: false,
                isSystem: true
            };
            
            chats[clientId].messages.push(newMessage);
            chats[clientId].info.lastActivity = new Date().toISOString();
            chats[clientId].info.unreadCount = (chats[clientId].info.unreadCount || 0) + 1;
            manageChatStorage(clientId);
            saveChats();
            
            // Отправляем push-уведомление
            sendPushNotification(order, 'approved');
            
            // Обновляем интерфейс если чат открыт
            if (isMaster && currentChatId === clientId) {
                renderMasterChatMessages();
            }
        }

        // Отправка сообщения об отклонении
        function sendRejectionMessage(order) {
            const clientId = getClientIdFromOrder(order);
            if (!clientId) return;
            
            if (!chats[clientId]) {
                createNewChat(clientId, order.client.name);
            }
            
            const newMessage = {
                id: Date.now(),
                text: approvalSettings.rejectedMessage,
                sender: 'master',
                timestamp: new Date().toISOString(),
                read: false,
                isSystem: true
            };
            
            chats[clientId].messages.push(newMessage);
            chats[clientId].info.lastActivity = new Date().toISOString();
            chats[clientId].info.unreadCount = (chats[clientId].info.unreadCount || 0) + 1;
            manageChatStorage(clientId);
            saveChats();
            
            // Отправляем push-уведомление
            sendPushNotification(order, 'rejected');
        }

        // Активация чата для заказа
        function activateChatForOrder(order) {
            const clientId = getClientIdFromOrder(order);
            if (!clientId) return;
            
            if (!chats[clientId]) {
                createNewChat(clientId, order.client.name);
            }
            
            // Помечаем что чат активирован для этого заказа
            if (!chats[clientId].info.orders) {
                chats[clientId].info.orders = [];
            }
            if (!chats[clientId].info.orders.includes(order.id)) {
                chats[clientId].info.orders.push(order.id);
            }
            saveChats();
        }

        // Получение clientId из заказа
        function getClientIdFromOrder(order) {
            if (order.client.userId && !String(order.client.userId).startsWith('user-')) {
                return `client_${order.client.userId}`;
            }
            // Если нет нормального ID, создаем по имени (не идеально, но работает)
            return `client_${order.client.name.replace(/\s+/g, '_')}_${order.id}`;
        }

        function deleteOrder(orderId) {
            if (confirm('Удалить этот заказ?')) {
                let orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
                orders = orders.filter(order => order.id !== orderId);
                localStorage.setItem('masterOrders', JSON.stringify(orders));
                updateAdminSchedule();
                showNotification('Заказ удален!', 'success');
            }
        }

        function clearAllBookings() {
            if (confirm('Вы уверены, что хотите очистить ВСЕ бронирования и заказы?')) {
                bookedSlots = [];
                saveBookedSlots();
                cart = [];
                localStorage.removeItem('masterOrders');
                updateCartDisplay();
                updateCartModal();
                updateAdminSchedule();
                showNotification('Все бронирования и заказы очищены!', 'success');
            }
        }

        function addTestBookings() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Добавляем тестовые бронирования
            bookTimeSlot(tomorrowStr, '10:00', 120);
            bookTimeSlot(tomorrowStr, '14:00', 210);
            bookTimeSlot(tomorrowStr, '16:30', 30);
            
            // Добавляем тестовые заказы
            const testOrders = [
                {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    services: [{
                        service: "Комплексный маникюр",
                        price: 1900,
                        date: tomorrowStr,
                        time: "10:00",
                        duration: 120,
                        bookingId: Date.now() + 1
                    }],
                    wishes: "Хочу нежный френч с розовым оттенком",
                    photo: null,
                    total: 1900,
                    status: 'pending',
                    client: {
                        name: "Ксения",
                        username: "@ksenia_nails",
                        userId: 123456789
                    }
                },
                {
                    id: Date.now() + 1,
                    date: new Date().toISOString(),
                    services: [{
                        service: "Наращивание до 3",
                        price: 2500,
                        date: tomorrowStr,
                        time: "14:00",
                        duration: 210,
                        bookingId: Date.now() + 2
                    }],
                    wishes: "",
                    photo: null,
                    total: 2500,
                    status: 'confirmed',
                    client: {
                        name: "Мария",
                        username: "@maria_beauty",
                        userId: 987654321
                    }
                }
            ];
            
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            testOrders.forEach(order => orders.push(order));
            localStorage.setItem('masterOrders', JSON.stringify(orders));
            
            updateAdminSchedule();
            showNotification('Тестовые записи добавлены!', 'success');
        }

        function exportSchedule() {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            console.log('Экспорт данных:', orders);
            showNotification('Данные экспортированы в консоль разработчика', 'info');
        }

        // ========== НОВЫЕ ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ГРАФИКОМ РАБОТЫ ==========
        function openScheduleSettings() {
            const modal = document.getElementById('scheduleSettingsModal');
            modal.classList.add('active');
            renderScheduleSettings();
        }

        function closeScheduleSettings() {
            const modal = document.getElementById('scheduleSettingsModal');
            modal.classList.remove('active');
        }

        function renderScheduleSettings() {
            const container = document.getElementById('scheduleSettings');
            const days = [
                { key: 'monday', name: 'Понедельник' },
                { key: 'tuesday', name: 'Вторник' },
                { key: 'wednesday', name: 'Среда' },
                { key: 'thursday', name: 'Четверг' },
                { key: 'friday', name: 'Пятница' },
                { key: 'saturday', name: 'Суббота' },
                { key: 'sunday', name: 'Воскресенье' }
            ];

            let html = '';
            days.forEach(day => {
                const schedule = workSchedule[day.key];
                html += `
                    <div class="day-schedule">
                        <div class="day-header">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="${day.key}-enabled" ${schedule.enabled ? 'checked' : ''}>
                                <strong>${day.name}</strong>
                            </label>
                        </div>
                        <div class="time-slots-input">
                            <input type="time" id="${day.key}-start" class="time-input" value="${schedule.start}" ${!schedule.enabled ? 'disabled' : ''}>
                            <span>—</span>
                            <input type="time" id="${day.key}-end" class="time-input" value="${schedule.end}" ${!schedule.enabled ? 'disabled' : ''}>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Добавляем обработчики для включения/выключения дней
            days.forEach(day => {
                const checkbox = document.getElementById(`${day.key}-enabled`);
                const startInput = document.getElementById(`${day.key}-start`);
                const endInput = document.getElementById(`${day.key}-end`);

                checkbox.addEventListener('change', function() {
                    startInput.disabled = !this.checked;
                    endInput.disabled = !this.checked;
                });
            });
        }

        function saveScheduleSettings() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                workSchedule[day] = {
                    enabled: document.getElementById(`${day}-enabled`).checked,
                    start: document.getElementById(`${day}-start`).value,
                    end: document.getElementById(`${day}-end`).value
                };
            });

            localStorage.setItem('workSchedule', JSON.stringify(workSchedule));
            closeScheduleSettings();
            updateSchedulePreview();
            showNotification('График работы сохранен!', 'success');
        }

        function setDefaultSchedule() {
            workSchedule = {
                monday: { enabled: true, start: "10:00", end: "20:00" },
                tuesday: { enabled: true, start: "10:00", end: "20:00" },
                wednesday: { enabled: true, start: "10:00", end: "20:00" },
                thursday: { enabled: true, start: "10:00", end: "20:00" },
                friday: { enabled: true, start: "10:00", end: "20:00" },
                saturday: { enabled: false, start: "10:00", end: "18:00" },
                sunday: { enabled: false, start: "10:00", end: "18:00" }
            };
            
            localStorage.setItem('workSchedule', JSON.stringify(workSchedule));
            updateSchedulePreview();
            showNotification('Установлен стандартный график!', 'success');
        }

        function updateSchedulePreview() {
            const container = document.getElementById('schedulePreview');
            const days = [
                { key: 'monday', name: 'Пн' },
                { key: 'tuesday', name: 'Вт' },
                { key: 'wednesday', name: 'Ср' },
                { key: 'thursday', name: 'Чт' },
                { key: 'friday', name: 'Пт' },
                { key: 'saturday', name: 'Сб' },
                { key: 'sunday', name: 'Вс' }
            ];

            let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">';
            days.forEach(day => {
                const schedule = workSchedule[day.key];
                if (schedule.enabled) {
                    html += `
                        <div style="background: #252525; padding: 8px 12px; border-radius: 8px; font-size: 12px;">
                            <div><strong>${day.name}</strong></div>
                            <div>${schedule.start} - ${schedule.end}</div>
                        </div>
                    `;
                }
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ========== УПРАВЛЕНИЕ УСЛУГАМИ ==========
        function openServiceEditor() {
            const modalHTML = `
                <div class="modal active" id="serviceEditorModal">
                    <div class="modal-content editor-modal">
                        <div class="modal-header">
                            <h3>Редактирование услуг</h3>
                            <button class="close-modal" onclick="closeServiceEditor()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="service-list-editor" id="serviceListEditor">
                                <!-- Список услуг будет здесь -->
                            </div>
                            <button class="admin-btn" onclick="addNewService()" style="width: 100%; margin-top: 16px;">
                                Добавить новую услугу
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderServiceList();
        }

        function closeServiceEditor() {
            const modal = document.getElementById('serviceEditorModal');
            if (modal) modal.remove();
        }

        function renderServiceList() {
            const container = document.getElementById('serviceListEditor');
            if (!container) return;
            
            let html = '';
            
            // Рендерим услуги из всех категорий
            for (const category in servicesData) {
                servicesData[category].forEach(service => {
                    html += `
                        <div class="service-editor-item">
                            <div class="service-editor-header">
                                <div>
                                    <div class="service-editor-name">${service.emoji} ${service.name}</div>
                                    <div class="service-editor-price">${service.price} ₽ • ${service.duration} мин</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 4px;">${service.description}</div>
                                </div>
                                <div class="service-editor-actions">
                                    <button class="edit-btn" onclick="editService(${service.id})">Изм</button>
                                    <button class="delete-btn" onclick="deleteService(${service.id})">Уд</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html || '<div class="empty-state"><p>Нет услуг</p></div>';
        }

        function findServiceById(serviceId) {
            for (const category in servicesData) {
                const service = servicesData[category].find(s => s.id === serviceId);
                if (service) return service;
            }
            return null;
        }

        function addNewService() {
            currentEditingService = null;
            openServiceForm();
        }

        function openServiceForm(service = null) {
            const modalHTML = `
                <div class="modal active" id="serviceFormModal">
                    <div class="modal-content editor-modal">
                        <div class="modal-header">
                            <h3>${service ? 'Редактирование услуги' : 'Новая услуга'}</h3>
                            <button class="close-modal" onclick="closeServiceForm()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="editor-form">
                                <div class="form-group">
                                    <label>Название услуги:</label>
                                    <input type="text" id="serviceName" class="form-input" placeholder="Например: Комплексный маникюр">
                                </div>
                                <div class="form-group">
                                    <label>Описание:</label>
                                    <textarea id="serviceDescription" class="form-textarea" placeholder="Описание услуги..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Цена (₽):</label>
                                    <input type="number" id="servicePrice" class="form-input" placeholder="1900">
                                </div>
                                <div class="form-group">
                                    <label>Длительность (минуты):</label>
                                    <input type="number" id="serviceDuration" class="form-input" placeholder="120">
                                </div>
                                <div class="form-group">
                                    <label>Категория:</label>
                                    <select id="serviceCategory" class="form-select">
                                        <option value="manicure">Маникюр</option>
                                        <option value="extension">Наращивание</option>
                                        <option value="correction">Коррекция</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Эмодзи для карточки:</label>
                                    <input type="text" id="serviceEmoji" class="form-input" placeholder="" maxlength="2">
                                </div>
                                <div class="form-actions">
                                    <button class="cancel-btn checkout-btn" onclick="closeServiceForm()">Отмена</button>
                                    <button class="save-btn checkout-btn" onclick="saveService()">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Заполняем форму если редактируем существующую услугу
            if (service) {
                document.getElementById('serviceName').value = service.name;
                document.getElementById('serviceDescription').value = service.description;
                document.getElementById('servicePrice').value = service.price;
                document.getElementById('serviceDuration').value = service.duration;
                document.getElementById('serviceCategory').value = service.category;
                document.getElementById('serviceEmoji').value = service.emoji;
            }
        }

        function editService(serviceId) {
            const service = findServiceById(serviceId);
            if (service) {
                currentEditingService = service;
                openServiceForm(service);
            }
        }

        function saveService() {
            const name = document.getElementById('serviceName').value.trim();
            const description = document.getElementById('serviceDescription').value.trim();
            const price = parseInt(document.getElementById('servicePrice').value);
            const duration = parseInt(document.getElementById('serviceDuration').value);
            const category = document.getElementById('serviceCategory').value;
            const emoji = document.getElementById('serviceEmoji').value.trim() || '💅';
            
            if (!name || !description || isNaN(price) || isNaN(duration)) {
                showNotification('Пожалуйста, заполните все поля корректно', 'error');
                return;
            }
            
            if (currentEditingService) {
                // Редактирование существующей услуги
                const oldCategory = currentEditingService.category;
                const serviceIndex = servicesData[oldCategory].findIndex(s => s.id === currentEditingService.id);
                
                if (serviceIndex !== -1) {
                    // Удаляем из старой категории
                    servicesData[oldCategory].splice(serviceIndex, 1);
                    
                    // Обновляем данные
                    currentEditingService.name = name;
                    currentEditingService.description = description;
                    currentEditingService.price = price;
                    currentEditingService.duration = duration;
                    currentEditingService.category = category;
                    currentEditingService.emoji = emoji;
                    
                    // Добавляем в новую категорию
                    servicesData[category].push(currentEditingService);
                }
            } else {
                // Создание новой услуги
                const newService = {
                    id: Date.now(),
                    name: name,
                    description: description,
                    price: price,
                    duration: duration,
                    emoji: emoji,
                    category: category
                };
                
                servicesData[category].push(newService);
            }
            
            saveServicesData();
            closeServiceForm();
            renderServiceList();
            updateServicesDisplay();
            showNotification('Услуга сохранена!', 'success');
        }

        function deleteService(serviceId) {
            if (!confirm('Удалить эту услугу?')) return;
            
            for (const category in servicesData) {
                const serviceIndex = servicesData[category].findIndex(s => s.id === serviceId);
                if (serviceIndex !== -1) {
                    servicesData[category].splice(serviceIndex, 1);
                    break;
                }
            }
            
            saveServicesData();
            renderServiceList();
            updateServicesDisplay();
            showNotification('Услуга удалена!', 'success');
        }

        function closeServiceForm() {
            const modal = document.getElementById('serviceFormModal');
            if (modal) modal.remove();
        }

        function saveServicesData() {
            localStorage.setItem('servicesData', JSON.stringify(servicesData));
            updateServicesDisplay();
        }

        // ========== РЕДАКТОР ЦЕН ==========
        function openPriceEditor() {
            const modalHTML = `
                <div class="modal active" id="priceEditorModal">
                    <div class="modal-content editor-modal">
                        <div class="modal-header">
                            <h3>Редактор цен</h3>
                            <button class="close-modal" onclick="closePriceEditor()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="service-list-editor" id="priceListEditor">
                                <!-- Список услуг для изменения цен -->
                            </div>
                            <div class="form-actions" style="margin-top: 16px;">
                                <button class="admin-btn" onclick="applyPercentageToAll()" style="flex: 1;">
                                    Изменить все цены на %
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderPriceList();
        }

        function closePriceEditor() {
            const modal = document.getElementById('priceEditorModal');
            if (modal) modal.remove();
        }

        function renderPriceList() {
            const container = document.getElementById('priceListEditor');
            if (!container) return;
            
            let html = '';
            
            for (const category in servicesData) {
                servicesData[category].forEach(service => {
                    html += `
                        <div class="service-editor-item">
                            <div class="service-editor-header">
                                <div class="service-editor-name">${service.emoji} ${service.name}</div>
                                <div class="service-editor-price">${service.price} ₽</div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="number" id="price-${service.id}" value="${service.price}" 
                                       style="flex: 1; background: #333; border: 1px solid #555; border-radius: 4px; color: white; padding: 6px;">
                                    <button class="edit-btn" onclick="updateServicePrice(${service.id})">Сохранить</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html || '<p>Нет услуг</p>';
        }

        function updateServicePrice(serviceId) {
            const newPrice = parseInt(document.getElementById(`price-${serviceId}`).value);
            
            if (isNaN(newPrice)) {
                showNotification('Введите корректную цену', 'error');
                return;
            }
            
            for (const category in servicesData) {
                const service = servicesData[category].find(s => s.id === serviceId);
                if (service) {
                    service.price = newPrice;
                    break;
                }
            }
            
            saveServicesData();
            renderPriceList();
            updateServicesDisplay();
            showNotification('Цена обновлена!', 'success');
        }

        function applyPercentageToAll() {
            const percentage = prompt('Введите процент для изменения цен (+ для увеличения, - для уменьшения):', '10');
            
            if (percentage === null) return;
            
            const percentValue = parseInt(percentage);
            if (isNaN(percentValue)) {
                showNotification('Введите корректное число', 'error');
                return;
            }
            
            if (!confirm(`Изменить все цены на ${percentValue}%?`)) return;
            
            for (const category in servicesData) {
                servicesData[category].forEach(service => {
                    const newPrice = Math.round(service.price * (1 + percentValue / 100));
                    service.price = newPrice;
                });
            }
            
            saveServicesData();
            renderPriceList();
            updateServicesDisplay();
            showNotification(`Все цены изменены на ${percentValue}%!`, 'success');
        }

        // ========== УПРАВЛЕНИЕ КОНТЕНТОМ ==========
        function changeMasterPhoto() {
            const imageUrl = prompt('Введите URL нового фото профиля мастера:');
            if (imageUrl && imageUrl.startsWith('http')) {
                localStorage.setItem('masterPhoto', imageUrl);
                updateMasterPhoto();
                showNotification('Фото профиля обновлено!', 'success');
            } else if (imageUrl) {
                showNotification('Пожалуйста, введите корректный URL (должен начинаться с http или https)', 'error');
            }
        }

        function updateMasterPhoto() {
            const masterPhoto = localStorage.getItem('masterPhoto');
            if (masterPhoto) {
                const avatar = document.querySelector('.master-avatar');
                if (avatar) {
                    avatar.style.backgroundImage = `url(${masterPhoto})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                    const avatarContent = avatar.querySelector('.avatar-content');
                    if (avatarContent) {
                        avatarContent.style.display = 'none';
                    }
                }
            }
        }

        function manageServicePhotos() {
            const modalHTML = `
                <div class="modal active" id="servicePhotosModal">
                    <div class="modal-content editor-modal">
                        <div class="modal-header">
                            <h3>Фото услуг</h3>
                            <button class="close-modal" onclick="closeServicePhotos()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="service-list-editor" id="servicePhotosList">
                                <!-- Список услуг для управления фото -->
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: #252525; border-radius: 8px;">
                                <p style="margin-bottom: 8px; color: #888;">Для каждой услуги можно установить свое фото</p>
                                <button class="admin-btn" onclick="addServicePhoto()" style="width: 100%;">
                                    Добавить фото для услуги
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderServicePhotosList();
        }

        function closeServicePhotos() {
            const modal = document.getElementById('servicePhotosModal');
            if (modal) modal.remove();
        }

        function renderServicePhotosList() {
            const container = document.getElementById('servicePhotosList');
            if (!container) return;
            
            let html = '';
            
            for (const category in servicesData) {
                servicesData[category].forEach(service => {
                    const servicePhoto = localStorage.getItem(`servicePhoto_${service.id}`) || '';
                    html += `
                        <div class="service-editor-item">
                            <div class="service-editor-header">
                                <div class="service-editor-name">${service.emoji} ${service.name}</div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                                <input type="text" id="service-photo-${service.id}" value="${servicePhoto}" 
                                       placeholder="URL фото для услуги"
                                       style="flex: 1; background: #333; border: 1px solid #555; border-radius: 4px; color: white; padding: 6px;">
                                <button class="edit-btn" onclick="saveServicePhoto(${service.id})">Сохранить</button>
                                <button class="delete-btn" onclick="clearServicePhoto(${service.id})">Удалить</button>
                            </div>
                            ${servicePhoto ? `
                                <div style="margin-top: 8px;">
                                    <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Предпросмотр:</div>
                                    <img src="${servicePhoto}" alt="${service.name}" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #333;">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html || '<p>Нет услуг</p>';
        }

        function saveServicePhoto(serviceId) {
            const photoUrl = document.getElementById(`service-photo-${serviceId}`).value.trim();
            
            if (photoUrl && !photoUrl.startsWith('http')) {
                showNotification('Пожалуйста, введите корректный URL (должен начинаться с http или https)', 'error');
                return;
            }
            
            if (photoUrl) {
                localStorage.setItem(`servicePhoto_${serviceId}`, photoUrl);
            } else {
                localStorage.removeItem(`servicePhoto_${serviceId}`);
            }
            
            showNotification('Фото услуги сохранено!', 'success');
            renderServicePhotosList();
        }

        function clearServicePhoto(serviceId) {
            if (confirm('Удалить фото для этой услуги?')) {
                localStorage.removeItem(`servicePhoto_${serviceId}`);
                document.getElementById(`service-photo-${serviceId}`).value = '';
                showNotification('Фото услуги удалено!', 'success');
                renderServicePhotosList();
            }
        }

        function addServicePhoto() {
            const serviceId = prompt('Введите ID услуги для добавления фото (можно найти в редакторе услуг):');
            if (!serviceId) return;
            
            const service = findServiceById(parseInt(serviceId));
            if (!service) {
                showNotification('Услуга с таким ID не найдена', 'error');
                return;
            }
            
            const photoUrl = prompt('Введите URL фото для услуги:');
            if (photoUrl && photoUrl.startsWith('http')) {
                localStorage.setItem(`servicePhoto_${service.id}`, photoUrl);
                renderServicePhotosList();
                showNotification('Фото для услуги добавлено!', 'success');
            } else if (photoUrl) {
                showNotification('Пожалуйста, введите корректный URL', 'error');
            }
        }

        // ========== СТАТИСТИКА С НАСТРОЙКАМИ ==========
        function openStatsSettings() {
            const modalHTML = `
                <div class="modal active" id="statsSettingsModal">
                    <div class="modal-content editor-modal">
                        <div class="modal-header">
                            <h3>Настройка статистики</h3>
                            <button class="close-modal" onclick="closeStatsSettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="editor-form">
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showToday" ${statsSettings.today ? 'checked' : ''}>
                                        Показывать "Сегодня"
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showWeek" ${statsSettings.week ? 'checked' : ''}>
                                        Показывать "Неделя"
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showMonth" ${statsSettings.month ? 'checked' : ''}>
                                        Показывать "Месяц"
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showTotal" ${statsSettings.total ? 'checked' : ''}>
                                        Показывать "Всего"
                                    </label>
                                </div>
                                <div class="form-actions">
                                    <button class="cancel-btn checkout-btn" onclick="closeStatsSettings()">Отмена</button>
                                    <button class="save-btn checkout-btn" onclick="saveStatsSettings()">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeStatsSettings() {
            const modal = document.getElementById('statsSettingsModal');
            if (modal) modal.remove();
        }

        function saveStatsSettings() {
            statsSettings.today = document.getElementById('showToday').checked;
            statsSettings.week = document.getElementById('showWeek').checked;
            statsSettings.month = document.getElementById('showMonth').checked;
            statsSettings.total = document.getElementById('showTotal').checked;
            
            localStorage.setItem('statsSettings', JSON.stringify(statsSettings));
            closeStatsSettings();
            updateAdminStats();
            showNotification('Настройки статистики сохранены!', 'success');
        }

        function showCustomPeriodStats() {
            const startDate = prompt('Введите начальную дату (ДД.ММ.ГГГГ):');
            const endDate = prompt('Введите конечную дату (ДД.ММ.ГГГГ):');
            
            if (!startDate || !endDate) return;
            
            const start = parseDate(startDate);
            const end = parseDate(endDate);
            
            if (!start || !end) {
                showNotification('Неверный формат даты. Используйте ДД.ММ.ГГГГ', 'error');
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            let periodOrders = 0;
            let periodEarnings = 0;
            
            orders.forEach(order => {
                const orderDate = new Date(order.date);
                if (orderDate >= start && orderDate <= end) {
                    periodOrders++;
                    periodEarnings += order.total;
                }
            });
            
            alert(`Статистика за период с ${startDate} по ${endDate}:\n\nЗаказов: ${periodOrders}\nВыручка: ${periodEarnings} ₽`);
        }

        function parseDate(dateString) {
            const parts = dateString.split('.');
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            
            const date = new Date(year, month, day);
            return isNaN(date.getTime()) ? null : date;
        }

        function exportStats() {
            const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
            const stats = {
                totalOrders: orders.length,
                totalEarnings: orders.reduce((sum, order) => sum + order.total, 0),
                period: new Date().toLocaleDateString('ru-RU'),
                orders: orders
            };
            
            console.log('Статистика для экспорта:', stats);
            showNotification('Статистика экспортирована в консоль разработчика', 'info');
        }

        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function showLoading(message = 'Загрузка...') {
            const loading = document.getElementById('globalLoading');
            if (loading) {
                loading.style.display = 'flex';
                loading.querySelector('div > div:last-child').textContent = message;
            }
        }

        function hideLoading() {
            const loading = document.getElementById('globalLoading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        // ========== МОДАЛЬНЫЕ ОКНА ==========
        function openTimeModal() {
            const modal = document.getElementById('timeModal');
            modal.classList.add('active');
            
            // Генерируем даты и фильтруем те, где нет доступных слотов для выбранной услуги
            const allDates = generateDates();
            const dateButtons = document.getElementById('dateButtons');
            dateButtons.innerHTML = '';
            
            // Фильтруем даты: оставляем только те, где есть хотя бы один доступный слот
            const availableDates = [];
            if (selectedService) {
                allDates.forEach(date => {
                    const timeSlots = generateTimeSlots(date.date, selectedService.duration);
                    const hasAvailableSlots = timeSlots.some(slot => slot.available);
                    if (hasAvailableSlots) {
                        availableDates.push(date);
                    }
                });
            } else {
                availableDates.push(...allDates);
            }
            
            // Если нет доступных дат, показываем все даты, но с предупреждением
            const datesToShow = availableDates.length > 0 ? availableDates : allDates;
            
            datesToShow.forEach((date, index) => {
                const button = document.createElement('button');
                button.className = 'date-btn' + (index === 0 ? ' active' : '');
                button.textContent = date.readable;
                button.setAttribute('data-date', date.date);
                
                // Если дата не имеет доступных слотов, помечаем её
                if (availableDates.length > 0 && !availableDates.find(d => d.date === date.date)) {
                    button.style.opacity = '0.5';
                    button.title = 'На эту дату нет доступного времени для выбранной услуги';
                }
                
                button.addEventListener('click', function() {
                    document.querySelectorAll('.date-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    selectedDate = this.getAttribute('data-date');
                    updateTimeSlots();
                });
                dateButtons.appendChild(button);
            });
            
            if (datesToShow.length > 0) {
                selectedDate = datesToShow[0].date;
            }
            
            // Если нет доступных дат, показываем предупреждение
            if (availableDates.length === 0 && selectedService) {
                const durationHours = Math.floor(selectedService.duration / 60);
                const durationMinutes = selectedService.duration % 60;
                const durationText = durationHours > 0 
                    ? `${durationHours}ч ${durationMinutes > 0 ? durationMinutes + 'м' : ''}`
                    : `${durationMinutes}м`;
                
                setTimeout(() => {
                    const timeSlotsContainer = document.getElementById('timeSlots');
                    if (timeSlotsContainer) {
                        timeSlotsContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #2a1a1a; border-radius: 12px;">
                                <p style="color: #ff8888; font-weight: 600; margin-bottom: 12px;">
                                    На ближайшие 30 дней нет доступного непрерывного времени для услуги длительностью ${durationText}
                                </p>
                                <p style="color: #888; font-size: 14px; margin-bottom: 16px;">
                                    Система ищет альтернативные варианты...
                                </p>
                            </div>
                        `;
                        
                        // Ищем альтернативные даты
                        const alternatives = findAlternativeSlots(selectedService.duration, 60); // Ищем до 60 дней
                        if (alternatives.length > 0) {
                            let alternativesHTML = `
                                <div style="background: #1a1a1a; border-radius: 12px; padding: 16px; margin-top: 16px;">
                                    <h4 style="color: #0078D4; margin-bottom: 12px; font-size: 16px;">
                                        Ближайшие доступные даты и время:
                                    </h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                            `;
                            
                            alternatives.forEach(alt => {
                                alternativesHTML += `
                                    <div style="background: #252525; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600;">${alt.readable}</div>
                                            <div style="color: #888; font-size: 14px;">${alt.time}</div>
                                        </div>
                                        <button class="date-btn" onclick="selectAlternativeSlot('${alt.date}', '${alt.time}')" style="padding: 8px 16px; font-size: 14px;">
                                            Выбрать
                                        </button>
                                    </div>
                                `;
                            });
                            
                            alternativesHTML += `
                                    </div>
                                </div>
                            `;
                            
                            timeSlotsContainer.innerHTML += alternativesHTML;
                        }
                    }
                }, 100);
            }
            
            updateTimeSlots();
        }

        function updateTimeSlots() {
            if (!selectedDate || !selectedService) return;
            
            const timeSlots = generateTimeSlots(selectedDate, selectedService.duration);
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';
            
            const availableSlots = timeSlots.filter(slot => slot.available);
            
            if (availableSlots.length === 0) {
                // Нет доступных слотов - показываем сообщение и альтернативы
                const durationHours = Math.floor(selectedService.duration / 60);
                const durationMinutes = selectedService.duration % 60;
                const durationText = durationHours > 0 
                    ? `${durationHours}ч ${durationMinutes > 0 ? durationMinutes + 'м' : ''}`
                    : `${durationMinutes}м`;
                
                let messageHTML = `
                    <div style="text-align: center; padding: 20px; background: #2a1a1a; border-radius: 12px; margin-bottom: 16px;">
                        <p style="color: #ff8888; font-weight: 600; margin-bottom: 12px;">
                            На выбранную дату нет непрерывного свободного времени для услуги длительностью ${durationText}
                        </p>
                        <p style="color: #888; font-size: 14px; margin-bottom: 16px;">
                            Система ищет альтернативные варианты...
                        </p>
                    </div>
                `;
                
                // Ищем альтернативные даты и время
                const alternatives = findAlternativeSlots(selectedService.duration);
                if (alternatives.length > 0) {
                    messageHTML += `
                        <div style="background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <h4 style="color: #0078D4; margin-bottom: 12px; font-size: 16px;">
                                Ближайшие доступные даты и время:
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;
                    
                    alternatives.forEach(alt => {
                        messageHTML += `
                            <div style="background: #252525; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">${alt.readable}</div>
                                    <div style="color: #888; font-size: 14px;">${alt.time}</div>
                                </div>
                                <button class="date-btn" onclick="selectAlternativeSlot('${alt.date}', '${alt.time}')" style="padding: 8px 16px; font-size: 14px;">
                                    Выбрать
                                </button>
                            </div>
                        `;
                    });
                    
                    messageHTML += `
                            </div>
                        </div>
                    `;
                }
                
                // Ищем услуги, которые помещаются в доступное время на выбранную дату
                const dayOfWeek = new Date(selectedDate).getDay();
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const daySchedule = workSchedule[dayNames[dayOfWeek]];
                
                if (daySchedule && daySchedule.enabled) {
                    // Находим максимальный доступный непрерывный интервал на этот день
                    const [startHour, startMinute] = daySchedule.start.split(':').map(Number);
                    const [endHour, endMinute] = daySchedule.end.split(':').map(Number);
                    const startTime = startHour * 60 + startMinute;
                    const endTime = endHour * 60 + endMinute;
                    
                    // Ищем максимальный свободный интервал
                    let maxAvailableDuration = 0;
                    let bestTime = null;
                    
                    for (let time = startTime; time < endTime; time += 30) {
                        const hour = Math.floor(time / 60);
                        const minute = time % 60;
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        // Проверяем сколько времени доступно с этого момента
                        const dayBookings = bookedSlots.filter(b => b.date === selectedDate)
                            .map(b => ({
                                start: new Date(`${b.date}T${b.startTime}`),
                                end: new Date(new Date(`${b.date}T${b.startTime}`).getTime() + b.duration * 60000)
                            }))
                            .sort((a, b) => a.start - b.start);
                        
                        const slotStart = new Date(`${selectedDate}T${timeString}`);
                        let availableUntil = new Date(`${selectedDate}T${daySchedule.end}`);
                        
                        for (const booking of dayBookings) {
                            if (booking.start > slotStart) {
                                availableUntil = booking.start;
                                break;
                            }
                        }
                        
                        const availableDuration = (availableUntil - slotStart) / 60000;
                        if (availableDuration > maxAvailableDuration) {
                            maxAvailableDuration = availableDuration;
                            bestTime = timeString;
                        }
                    }
                    
                    if (maxAvailableDuration >= 30 && bestTime) {
                        const fittingServices = findFittingServices(selectedDate, bestTime, maxAvailableDuration);
                        
                        if (fittingServices.length > 0) {
                            messageHTML += `
                                <div style="background: #1a1a1a; border-radius: 12px; padding: 16px;">
                                    <h4 style="color: #00a86b; margin-bottom: 12px; font-size: 16px;">
                                        Альтернативные услуги, которые помещаются в доступное время:
                                    </h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                            `;
                            
                            fittingServices.forEach(service => {
                                const serviceHours = Math.floor(service.duration / 60);
                                const serviceMinutes = service.duration % 60;
                                const serviceDurationText = serviceHours > 0 
                                    ? `${serviceHours}ч ${serviceMinutes > 0 ? serviceMinutes + 'м' : ''}`
                                    : `${serviceMinutes}м`;
                                
                                messageHTML += `
                                    <div style="background: #252525; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600;">${service.name}</div>
                                            <div style="color: #888; font-size: 14px;">${serviceDurationText} • ${service.price} ₽</div>
                                        </div>
                                        <button class="book-btn" onclick="selectAlternativeService(${service.id})" style="padding: 8px 16px; font-size: 14px;">
                                            Выбрать
                                        </button>
                                    </div>
                                `;
                            });
                            
                            messageHTML += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
                
                timeSlotsContainer.innerHTML = messageHTML;
            } else {
                // Есть доступные слоты - показываем их как обычно
                timeSlots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot' + (slot.available ? '' : ' booked');
                    slotElement.textContent = slot.time;
                    
                    if (slot.available) {
                        slotElement.addEventListener('click', function() {
                            document.querySelectorAll('.time-slot').forEach(s => {
                                s.classList.remove('active');
                            });
                            this.classList.add('active');
                            selectedTime = slot.time;
                        });
                    }
                    
                    timeSlotsContainer.appendChild(slotElement);
                });
            }
            
            selectedTime = null;
        }

        // Функция для выбора альтернативного слота
        function selectAlternativeSlot(date, time) {
            selectedDate = date;
            selectedTime = time;
            
            // Обновляем активную дату
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-date') === date) {
                    btn.classList.add('active');
                }
            });
            
            // Обновляем слоты времени
            updateTimeSlots();
            
            // Выделяем выбранное время
            setTimeout(() => {
                const timeSlots = document.querySelectorAll('.time-slot');
                timeSlots.forEach(slot => {
                    if (slot.textContent === time) {
                        slot.classList.add('active');
                    }
                });
            }, 100);
        }

        // Функция для выбора альтернативной услуги
        function selectAlternativeService(serviceId) {
            // Находим услугу
            let service = null;
            for (const category in servicesData) {
                service = servicesData[category].find(s => s.id === serviceId);
                if (service) break;
            }
            
            if (!service) return;
            
            // Обновляем выбранную услугу
            selectedService = {
                service: service.name,
                price: service.price,
                duration: service.duration
            };
            
            // Обновляем слоты времени
            updateTimeSlots();
            
            showNotification(`Выбрана услуга: ${service.name}`, 'success');
        }

        function closeTimeModal() {
            document.getElementById('timeModal').classList.remove('active');
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.remove('active');
        }

        // Автоматическое обновление графика каждую минуту
        setInterval(() => {
            if (document.getElementById('timeModal').classList.contains('active')) {
                updateTimeSlots();
            }
        }, 60000);

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация кнопки переключения режима
            document.getElementById('modeToggle').addEventListener('click', toggleMasterMode);
            updateUIForUserRole();

            // Инициализация основных компонентов
            loadServices();
            updateWorksDisplay();
            updateMasterPhoto();
            renderReviews();
            initReviewForm();
            initChatSystem(); // Инициализация системы чатов
            updateFavoritesDisplay();
            updateClientAppointments(); // Инициализация списка заказов клиента
            updateSchedulePreview(); // Инициализация предпросмотра графика
            updateChatStats(); // Инициализация статистики чата

            // Навигация между вкладками
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchToTab(this.getAttribute('data-tab'));
                });
            });

            // Навигация по категориям услуг
            document.querySelectorAll('.service-category').forEach(category => {
                category.addEventListener('click', function() {
                    document.querySelectorAll('.service-category').forEach(cat => {
                        cat.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.services-list').forEach(list => {
                        list.classList.remove('active');
                    });
                    
                    const categoryId = this.getAttribute('data-category');
                    document.getElementById(categoryId + '-services').classList.add('active');
                });
            });

            // Навигация по вкладкам профиля
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Пропускаем обработку для подвкладок "Активные записи" и "История"
                    if (this.hasAttribute('data-appointments-tab')) {
                        return;
                    }
                    
                    document.querySelectorAll('.profile-tab').forEach(t => {
                        if (!t.hasAttribute('data-appointments-tab')) {
                            t.classList.remove('active');
                        }
                    });
                    this.classList.add('active');
                    
                    const tabId = this.getAttribute('data-profile-tab');
                    
                    document.getElementById('appointmentsContent').style.display = 'none';
                    document.getElementById('favoritesContent').style.display = 'none';
                    document.getElementById('loyaltyContent').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'none';
                    
                    if (tabId === 'appointments') {
                        document.getElementById('appointmentsContent').style.display = 'block';
                        updateClientAppointments(); // Обновляем список заказов
                    } else if (tabId === 'favorites') {
                        document.getElementById('favoritesContent').style.display = 'block';
                    } else if (tabId === 'loyalty') {
                        document.getElementById('loyaltyContent').style.display = 'block';
                        updateLoyaltyDisplay();
                    } else if (tabId === 'admin') {
                        document.getElementById('adminContent').style.display = 'block';
                        updateAdminSchedule();
                        updateAdminStats();
                        updateChatStats(); // Обновляем статистику чата при открытии админки
                        updateApprovalSettingsPreview(); // Обновляем предпросмотр настроек сообщений
                        updateFreeTimePreview(); // Обновляем предпросмотр свободного времени
                    }
                });
            });

            // Навигация между подвкладками "Активные записи" и "История записей"
            document.addEventListener('click', function(e) {
                if (e.target.hasAttribute('data-appointments-tab')) {
                    const tabType = e.target.getAttribute('data-appointments-tab');
                    const activeContainer = document.getElementById('activeAppointmentsContent');
                    const historyContainer = document.getElementById('historyAppointmentsContent');
                    const tabs = document.querySelectorAll('[data-appointments-tab]');
                    
                    tabs.forEach(tab => {
                        if (tabType === 'active') {
                            if (tab === e.target) {
                                tab.style.color = '#0078D4';
                                tab.style.borderBottom = '2px solid #0078D4';
                            } else {
                                tab.style.color = '#888';
                                tab.style.borderBottom = '2px solid transparent';
                            }
                        } else if (tabType === 'history') {
                            if (tab === e.target) {
                                tab.style.color = '#0078D4';
                                tab.style.borderBottom = '2px solid #0078D4';
                            } else {
                                tab.style.color = '#888';
                                tab.style.borderBottom = '2px solid transparent';
                            }
                        }
                    });
                    
                    if (tabType === 'active') {
                        if (activeContainer) activeContainer.style.display = 'block';
                        if (historyContainer) historyContainer.style.display = 'none';
                    } else if (tabType === 'history') {
                        if (activeContainer) activeContainer.style.display = 'none';
                        if (historyContainer) historyContainer.style.display = 'block';
                    }
                }
            });

            // Обработчики кнопок "Выбрать время"
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('book-btn')) {
                    const service = e.target.getAttribute('data-service');
                    const price = parseInt(e.target.getAttribute('data-price'));
                    const duration = parseInt(e.target.getAttribute('data-duration'));
                    
                    selectedService = { service, price, duration };
                    openTimeModal();
                }
            });

            // Подтверждение выбора времени
            document.getElementById('confirmTimeBtn').addEventListener('click', function() {
                if (!selectedDate || !selectedTime) {
                    showNotification('Пожалуйста, выберите дату и время', 'error');
                    return;
                }
                
                addToCart(selectedService.service, selectedService.price, selectedDate, selectedTime, selectedService.duration);
                closeTimeModal();
                document.getElementById('cartModal').classList.add('active');
                updateCartModal();
            });

            // Обработчик загрузки фото
            document.getElementById('addPhotoBtn').addEventListener('click', function() {
                document.getElementById('photoReference').click();
            });

            document.getElementById('photoReference').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        referencePhoto = e.target.result;
                        document.getElementById('photoPreview').innerHTML = 
                            `<img src="${referencePhoto}" alt="Пример">`;
                        showNotification('Фото успешно загружено!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Обработчики для мастера (чат)
            document.getElementById('backToChats').addEventListener('click', backToChatsList);
            document.getElementById('masterSendMessageBtn').addEventListener('click', sendMasterMessage);
            document.getElementById('masterMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMasterMessage();
            });
            document.getElementById('masterAttachPhotoBtn').addEventListener('click', () => {
                document.getElementById('masterChatPhotoInput').click();
            });
            document.getElementById('masterChatPhotoInput').addEventListener('change', handleMasterPhotoUpload);

            // Обработчики для клиента (чат)
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('attachPhotoBtn').addEventListener('click', () => {
                document.getElementById('chatPhotoInput').click();
            });
            document.getElementById('chatPhotoInput').addEventListener('change', handlePhotoUpload);

            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    closeTimeModal();
                    closeCartModal();
                    closePhotoManager();
                    closeServiceEditor();
                    closeServiceForm();
                    closePriceEditor();
                    closeServicePhotos();
                    closeStatsSettings();
                    closeScheduleSettings();
                    closeChatSettings();
                    closeApprovalSettings();
                    closeFreeTimeManager();
                    closeChatManager();
                });
            });

            document.getElementById('checkoutBtn').addEventListener('click', checkout);

            // Закрытие модальных окон при клике вне их
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        if (this.id === 'timeModal') closeTimeModal();
                        if (this.id === 'cartModal') closeCartModal();
                        if (this.id === 'photoManagerModal') closePhotoManager();
                        if (this.id === 'serviceEditorModal') closeServiceEditor();
                        if (this.id === 'serviceFormModal') closeServiceForm();
                        if (this.id === 'priceEditorModal') closePriceEditor();
                        if (this.id === 'servicePhotosModal') closeServicePhotos();
                        if (this.id === 'statsSettingsModal') closeStatsSettings();
                        if (this.id === 'scheduleSettingsModal') closeScheduleSettings();
                        if (this.id === 'chatSettingsModal') closeChatSettings();
                        if (this.id === 'approvalSettingsModal') closeApprovalSettings();
                        if (this.id === 'freeTimeModal') closeFreeTimeManager();
                        if (this.id === 'chatManagerModal') closeChatManager();
                    }
                });
            });

            // Автоматическая очистка старых сообщений при загрузке
            setTimeout(() => {
                manageChatStorage();
            }, 1000);
            
            // Периодическая проверка размера хранилища
            setInterval(() => {
                manageChatStorage();
            }, 30000); // Каждые 30 секунд

            // ========== СИНХРОНИЗАЦИЯ ЧАТА ==========
            let lastChatUpdate = Date.now();
            let chatSyncInterval = null;

            function startChatSync() {
                if (chatSyncInterval) clearInterval(chatSyncInterval);
                
                chatSyncInterval = setInterval(() => {
                    syncChatMessages();
                }, 3000); // Синхронизация каждые 3 секунды
            }

            function stopChatSync() {
                if (chatSyncInterval) {
                    clearInterval(chatSyncInterval);
                    chatSyncInterval = null;
                }
            }

            function syncChatMessages() {
                const currentChats = JSON.parse(localStorage.getItem('chats')) || {};
                const currentUpdate = JSON.stringify(currentChats);
                
                // Проверяем изменения в чатах
                if (currentUpdate !== JSON.stringify(chats)) {
                    // Обновляем локальные чаты
                    Object.keys(currentChats).forEach(chatId => {
                        if (!chats[chatId] || 
                            currentChats[chatId].messages.length !== chats[chatId].messages.length) {
                            chats[chatId] = currentChats[chatId];
                        }
                    });
                    
                    // Обновляем интерфейс если чат открыт
                    if (isMaster && currentChatId) {
                        renderMasterChatMessages();
                    } else if (!isMaster && currentChatId) {
                        renderChatMessages();
                    }
                    
                    // Обновляем список чатов для мастера
                    if (isMaster) {
                        renderChatsList();
                    }
                }
            }

            // Запускаем синхронизацию при открытии чата
            if (document.getElementById('chat')) {
                startChatSync();
            }

            // ========== PUSH-УВЕДОМЛЕНИЯ ==========
            function checkUpcomingAppointments() {
                const orders = JSON.parse(localStorage.getItem('masterOrders')) || [];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                const todayStr = new Date().toISOString().split('T')[0];
                
                // Проверяем записи на завтра
                const tomorrowOrders = orders.filter(order => {
                    const firstService = order.services[0];
                    return firstService.date === tomorrowStr && 
                           order.status === 'confirmed' &&
                           !order.notificationSent;
                });
                
                tomorrowOrders.forEach(order => {
                    sendPushNotification(order, 'reminder');
                    order.notificationSent = true;
                });
                
                // Сохраняем обновленные заказы
                if (tomorrowOrders.length > 0) {
                    localStorage.setItem('masterOrders', JSON.stringify(orders));
                }
            }


            // Проверяем уведомления каждые 5 минут
            setInterval(() => {
                checkUpcomingAppointments();
            }, 5 * 60 * 1000);
            
            // Проверяем сразу при загрузке
            setTimeout(() => {
                checkUpcomingAppointments();
            }, 2000);

            console.log('Nails Master PRO App загружен!');
            showNotification('Добро пожаловать в Nails Master PRO!', 'success');
        });
    </script>
</body>
</html>
